<!doctype html>
<html class="docs-version-current" lang="en-US" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<title data-rh="true">Verify Smart Contract: Move Prover Tutorials | Starcoin Cookbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://starcoinorg.github.io/starcoin-cookbook/docs/move/move-prover/mvp-tutorial"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Verify Smart Contract: Move Prover Tutorials | Starcoin Cookbook"><meta data-rh="true" name="description" content="What is Move Prover"><meta data-rh="true" property="og:description" content="What is Move Prover"><link data-rh="true" rel="icon" href="/starcoin-cookbook/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://starcoinorg.github.io/starcoin-cookbook/docs/move/move-prover/mvp-tutorial"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/move/move-prover/mvp-tutorial" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/move/move-prover/mvp-tutorial" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/move/move-prover/mvp-tutorial" hreflang="x-default"><link rel="stylesheet" href="/starcoin-cookbook/assets/css/styles.78689d21.css">
<link rel="preload" href="/starcoin-cookbook/assets/js/runtime~main.0760d43c.js" as="script">
<link rel="preload" href="/starcoin-cookbook/assets/js/main.7e346ee4.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/starcoin-cookbook/"><div class="navbar__logo"><img src="/starcoin-cookbook/img/logo.png" alt="Starcoin Cookbook" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/starcoin-cookbook/img/logo.png" alt="Starcoin Cookbook" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Starcoin Cookbook</b></a><a class="navbar__item navbar__link navbar__link--active" href="/starcoin-cookbook/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/starcoin-cookbook/docs/move/move-prover/mvp-tutorial" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/starcoin-cookbook/zh/docs/move/move-prover/mvp-tutorial" target="_self" rel="noopener noreferrer" class="dropdown__link">‰∏≠Êñá</a></li></ul></div><a href="https://github.com/starcoinorg/starcoin-cookbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="Switch between dark and light mode (currently light mode)"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/starcoin-cookbook/docs/intro">Starcoin CookBook Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/starcoin-cookbook/docs/getting-started/install/">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/starcoin-cookbook/docs/move/">Move and SmartContract Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Move and SmartContract Development&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/prepare-move-env">Setting up Move develop environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/move-language/">Move Language</a><button aria-label="Toggle the collapsible sidebar category &#x27;Move Language&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/understanding-ability">Understanding abilities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/move-package-manager">User Guide of Move Package Manager</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/starcoin-framework/">Starcoin Move Framework</a><button aria-label="Toggle the collapsible sidebar category &#x27;Starcoin Move Framework&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/deploy-first-move-contract">Deploy your first Move contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/interacting-with-the-contract">Interactiong with the contract by CLI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/module-dependency">Understanding module dependency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/how-to-upgrade">How to upgrade Move Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/for-solidity-developer">For solidity developer</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/starcoin-cookbook/docs/move/move-test/move-unit-test">How to test Move Module</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/starcoin-cookbook/docs/move/move-examples/create-a-new-token">More Move Examples</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/starcoin-cookbook/docs/move/advance-move/how-to-design-permission-system">Advance Move Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/starcoin-cookbook/docs/move/move-prover/move-spec-language">Move Specification Language and Move Prover</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/docs/move/move-prover/move-spec-language">Move Specification Language</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/starcoin-cookbook/docs/move/move-prover/mvp-tutorial">Verify Smart Contract: Move Prover Tutorials</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/starcoin-cookbook/docs/web3/">Web3 and DApp Development</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web3 and DApp Development&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/starcoin-cookbook/docs/reference/">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/starcoin-cookbook/docs/concepts/merkletree">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/starcoin-cookbook/docs/miscellaneous/contributing">Miscellaneous</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/starcoin-cookbook/">üè†</a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/starcoin-cookbook/docs/move/">Move and SmartContract Development</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Move Specification Language and Move Prover</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/starcoin-cookbook/docs/move/move-prover/mvp-tutorial">Verify Smart Contract: Move Prover Tutorials</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Verify Smart Contract: Move Prover Tutorials</h1><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-is-move-prover">What is Move Prover<a class="hash-link" href="#what-is-move-prover" title="Direct link to heading">‚Äã</a></h2><p>Formal verification is a technique that uses rigorous mathematical methods to describe the behavior and reason about the correctness of computer systems.
Now it has certain applications in the fields of operating systems, compilers and other fields that require high correctness.</p><p>Smart contracts deployed on the blockchain manipulate various digital assets, and their correctness is also critical.
<strong>Move Prover (MVP)</strong> is designed to prevent bugs in smart contracts written in the Move language.
Users can specify functional properties of smart contracts using the <strong>Move Specification Language (MSL)</strong>, and then use Move Prover to automatically and statically inspect them.</p><p>Simply put, there can be two components in a Move file:</p><ul><li><p>Part of it is program code, which is the part most of us are most familiar with. It is written in the Move programming language (sometimes just called the Move language). We use it to define data types, functions.</p></li><li><p>The other part is the Formal specification. It is optional and written in the Move specification language. We use it to describe what properties a program code should satisfy. Such as describing the behavior of a function.</p></li></ul><p>When we write the formal specification, after calling the Move Prover, it will verify whether the Move program meets these requirements according to the written specification, helping developers to find potential problems as early as possible in the development stage, and give other users confidence in the properties of the program that has been verified.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="install-prover-dependencies">Install Prover dependencies<a class="hash-link" href="#install-prover-dependencies" title="Direct link to heading">‚Äã</a></h2><p>Before using Move Prover, let&#x27;s install some of its external dependencies.
It is assumed that you already have a copy of the <a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer">Starcoin</a> source code and have built the project.
We switch to the root directory of Starcoin and run the following command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$PATH_TO_STARCOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/dev_setup.sh -ypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> ~/.profile</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When the above command is executed, enter <code>boogie /version</code>, if the output is similar to &quot;Boogie program verifier version X.X.X&quot;, then the installation has been successful.</p><p>Note that currently Move Prover can only run under UNIX-based operating systems (such as Linux, macOS).
Windows users can run it by installing <a href="https://docs.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer">WSL</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="prepare-an-example-for-verification">Prepare an example for verification<a class="hash-link" href="#prepare-an-example-for-verification" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="project-creation">Project creation<a class="hash-link" href="#project-creation" title="Direct link to heading">‚Äã</a></h3><p>First, let&#x27;s create a new empty Move package:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mpm package new BasicCoin</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can see that its directory structure is as follows:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">BasicCoin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |---- Move.toml (text file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `---- sources   (Directory)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="module-code">Module code<a class="hash-link" href="#module-code" title="Direct link to heading">‚Äã</a></h3><p>Now create <code>BasicCoin/sources/BasicCoin.move</code>.</p><details class="details_lb9f alert alert--info details_BAp3" data-collapsed="true"><summary> BasicCoin.move content</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/// This module defines a minimal and generic Coin and Balance.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module NamedAddr::BasicCoin {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use StarcoinFramework::Errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use StarcoinFramework::Signer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Error codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const ENOT_MODULE_OWNER: u64 = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const EINSUFFICIENT_BALANCE: u64 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const EALREADY_HAS_BALANCE: u64 = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct Coin&lt;phantom CoinType&gt; has store {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: u64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct Balance&lt;phantom CoinType&gt; has key {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        coin: Coin&lt;CoinType&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Publish an empty balance resource under `account`&#x27;s address. This function must be called before</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// minting or transferring to the account.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun publish_balance&lt;CoinType&gt;(account: &amp;signer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let empty_coin = Coin&lt;CoinType&gt; { value: 0 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert!(!exists&lt;Balance&lt;CoinType&gt;&gt;(Signer::address_of(account)), Errors::already_published(EALREADY_HAS_BALANCE));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        move_to(account, Balance&lt;CoinType&gt; { coin:  empty_coin });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Mint `amount` tokens to `mint_addr`. This method requires a witness with `CoinType` so that the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// module that owns `CoinType` can decide the minting policy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun mint&lt;CoinType: drop&gt;(mint_addr: address, amount: u64, _witness: CoinType) acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Deposit `total_value` amount of tokens to mint_addr&#x27;s balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deposit(mint_addr, Coin&lt;CoinType&gt; { value: amount });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun balance_of&lt;CoinType&gt;(owner: address): u64 acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        borrow_global&lt;Balance&lt;CoinType&gt;&gt;(owner).coin.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Transfers `amount` of tokens from `from` to `to`. This method requires a witness with `CoinType` so that the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// module that owns `CoinType` can  decide the transferring policy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun transfer&lt;CoinType: drop&gt;(from: &amp;signer, to: address, amount: u64, _witness: CoinType) acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let check = withdraw&lt;CoinType&gt;(addr_from, amount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deposit&lt;CoinType&gt;(to, check);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun withdraw&lt;CoinType&gt;(addr: address, amount: u64) : Coin&lt;CoinType&gt; acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance = balance_of&lt;CoinType&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert!(balance &gt;= amount, EINSUFFICIENT_BALANCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance_ref = &amp;mut borrow_global_mut&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *balance_ref = balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Coin&lt;CoinType&gt; { value: amount }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun deposit&lt;CoinType&gt;(addr: address, check: Coin&lt;CoinType&gt;) acquires Balance{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance = balance_of&lt;CoinType&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance_ref = &amp;mut borrow_global_mut&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let Coin { value } = check;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *balance_ref = balance + value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div></div></details><p>Here we assume that you have a certain grasp of the Move language, and can understand the source code of <code>BasicCoin.move</code> above and know the function of each part.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="toml-configuration">TOML configuration<a class="hash-link" href="#toml-configuration" title="Direct link to heading">‚Äã</a></h3><p>BasicCoin uses some facilities of the Starcoin standard library, and also needs to add <code>StarcoinFramework</code> to the dependencies.
At the same time, the named address is used in BasicCoin, and we also need to specify what numerical address it should be replaced with.
Therefore, we modify Move.toml as follows:</p><div class="codeBlockContainer_I0IT language-toml theme-code-block"><div class="codeBlockContent_wNvx toml"><pre tabindex="0" class="prism-code language-toml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">[package]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name = &quot;BasicCoin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version = &quot;0.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[addresses]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NamedAddr = &quot;0xcafe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StarcoinFramework = { git = &quot;https://github.com/starcoinorg/starcoin-framework&quot;, rev=&quot;01c84198819310620f2417413c3c800df8292ae5&quot; }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-first-verification-code">The first verification code<a class="hash-link" href="#the-first-verification-code" title="Direct link to heading">‚Äã</a></h2><p>To give us a first impression of the use of Move Prover, add the following code snippet to BasicCoin.move:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Syntactically, this code can be added anywhere in the BasicCoin module, but it is recommended to place it after the definition of the <code>balance_of</code> function in order to clearly see the correspondence between the definition and the specification when reading the code.</p><p>Simply put, the <code>spec balance_of {...}</code> block will contain our <strong>property specification</strong> for the <code>balance_of</code> function.
There are many types of property specifications, some common examples are:</p><ul><li>Will this function abort? Under what circumstances does it abort?</li><li>What conditions must be met for the parameters to call this function?</li><li>What is the return value of this function?</li><li>After the function is executed, how will the state of the virtual machine be changed?</li><li>What invariants does this function maintain?</li></ul><p>For example, Move Prover allows all possible aborts by default when we don&#x27;t give any abort conditions.
And in the simple snippet above, we tell Prover with the directive <code>aborts_if_is_strict</code>:</p><blockquote><p>I would like to strictly check the possibility of aborting this function. Report an error if there is any abort not listed by the programmer.</p></blockquote><p>Now, we run the <code>prove</code> command in the <code>BasicCoin</code> directory:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mpm package prove</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>mpm will call Move Prover to check the code in the package.
Then we can see the Prover reporting the following error message:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">error: abort not covered by any of the `aborts_if` clauses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îå‚îÄ ./sources/BasicCoin.move:38:5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">35 ‚îÇ           borrow_global&lt;Balance&lt;CoinType&gt;&gt;(owner).coin.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ           ------------- abort happened here with execution failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ¬∑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38 ‚îÇ ‚ï≠     spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">39 ‚îÇ ‚îÇ       pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">40 ‚îÇ ‚îÇ     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:34: balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         owner = 0x29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:35: balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         ABORTED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: exiting with verification errors</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Prover&#x27;s output tells us that it found a situation where the <code>balance_of</code> function aborts, but we don&#x27;t explicitly point out the possibility of such aborts.
Looking at the code that triggers the abort, we can see that the exception is caused by calling the built-in <code>borrow_global</code> function when the <code>owner</code> does not own a resource of type <code>Balance&lt;CoinType&gt;</code>.
Following the guidance of the error message, we can add the following <code>aborts_if</code> condition:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(owner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>After adding this condition, try calling Prover again and see that there are no more validation errors.
Now we can confidently confirm that the <code>balance_of</code> function has one and only one possibility of abnormal termination, that is, the parameter <code>owner</code> does not own a resource of type <code>Balance&lt;CoinType&gt;</code>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="verify-withdraw-function">Verify withdraw function<a class="hash-link" href="#verify-withdraw-function" title="Direct link to heading">‚Äã</a></h2><p>The signature of the function <code>withdraw</code> is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun withdraw&lt;CoinType&gt;(addr: address, amount: u64) : Coin&lt;CoinType&gt; acquires Balance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Its role is to withdraw the <code>amount</code> of coins from the address <code>addr</code> and return it.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="specify-the-abort-condition-for-widthdraw">Specify the abort condition for <code>widthdraw</code><a class="hash-link" href="#specify-the-abort-condition-for-widthdraw" title="Direct link to heading">‚Äã</a></h3><p>There are two possibilities for <code>withdraw</code> to abort:</p><ol><li>No resource of type <code>Balance&lt;CoinType&gt;</code> in <code>addr</code>.</li><li>The balance in <code>addr</code> is less than <code>amount</code>.</li></ol><p>From these, we can define the abort condition like this:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>A spec block can contain let bindings, which bind a long expression with a name that can be used repeatedly.
<code>global&lt;T&gt;(addr): T</code> is a built-in function that returns a resource of type <code>T</code> at address <code>addr</code>.
Here, we set balance to the number of tokens owned by addr via the let binding;</li><li><code>exists&lt;T&gt;(address): bool</code> is a built-in function that returns true if resource <code>T</code> exists at address <code>addr</code>; otherwise returns false.</li></ul><p>The two lines of <code>aborts_if</code> statements correspond to the two conditions mentioned above.
In general, if a function has multiple <code>aborts_if</code> conditions, the conditions are ORed together.</p><p>As mentioned earlier, if we don&#x27;t specify any abort conditions, Prover will not impose any restrictions on aborts.
But once we give any kind of abort conditions, Prover defaults that we want to strictly check all possible aborts, so we need to list all possible conditions, which is equivalent to implicitly adding the instruction <code>pragma aborts_if_is_strict</code>.
If only some of the conditions for abnormal exit are listed, the Prover will report a validation error.
However, if the <code>pragma aborts_if_is_partial</code> is defined in the spec block, this is equivalent to telling the Prover:</p><blockquote><p>I just want to list some of the conditions that will cause an abort, please just verify that it will abort under those conditions.</p></blockquote><p>If you are interested, you can do such a set of experiments to verify:</p><ul><li>When deleting any of the above two <code>aborts_if</code> conditions, Prover will report an error;</li><li>When all <code>aborts_if</code> conditions are deleted at the same time, Prover will not report an error;</li><li>When adding <code>pragma aborts_if_is_partial</code>, no matter how many <code>aborts_if</code> conditions are kept, Prover will not report an error (of course, the conditions themselves must be correct).</li></ul><p>Some readers may be curious about the order of the three statements in the spec block:
Why the definition of balance can be written after <code>aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr)</code>.
Because, if the latter holds true, <code>balance</code> does not actually exist.
Wouldn&#x27;t this order cause the Prover to fail?
Simply put: no, the statements in the spec block are declarative and the order doesn&#x27;t matter.</p><p>For a more detailed understanding, you can refer to the MSL documentation for more information.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="specify-the-functional-nature-of-withdraw">Specify the functional nature of <code>withdraw</code><a class="hash-link" href="#specify-the-functional-nature-of-withdraw" title="Direct link to heading">‚Äã</a></h3><p>Next we define functional properties.
The two <code>ensures</code> statements in the following spec block give us what we expect from the <code>widthdraw</code> functionality:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures result == Coin&lt;CoinType&gt; { value: amount };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this code, first by using <code>let post</code> binding, define <code>balance_post</code> as the balance of <code>addr</code> after the function is executed, it should be equal to <code>balance - amount</code>. Then, <code>result</code> is a special name that represents the return value, which should be the <code>amount</code> of tokens.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="verify-the-deposit-function">Verify the <code>deposit</code> function<a class="hash-link" href="#verify-the-deposit-function" title="Direct link to heading">‚Äã</a></h2><p>The signature of the function deposit is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fun deposit&lt;CoinType&gt;(addr: address, check: Coin&lt;CoinType&gt;) acquires Balance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It deposits the token funds indicated by <code>check</code> into the address <code>addr</code>. Its canonical definition is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec deposit {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let check_value = check.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + check_value &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + check_value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here, <code>balance</code> is defined as the balance in <code>addr</code> before the function is executed, and <code>check_value</code> is defined as the amount of tokens to be deposited. It will abort in two cases:</p><ol><li>There is no resource of type <code>Balance&lt;CoinType&gt;</code> in <code>addr</code>;</li><li>Or the sum of <code>balance</code> and <code>check_value</code> is greater than the maximum value of type <code>u64</code>.</li></ol><p>The <code>ensures</code> statement is used to let the Prover make sure that in any case, the balance in <code>addr</code> can be updated correctly after the function is executed.</p><p>The syntax mentioned earlier will not be repeated here.
Astute readers may have noticed that it is worth noting that the expression <code>balance + check_value &gt; MAX_U64</code> is problematic in the Move program.
Because the addition on the left may cause an overflow exception.
If we want to write a similar check in the Move program, we should use an expression like <code>balance &gt; MAX_U64 - check_value</code> to avoid the overflow problem.</p><p>However, this expression is perfectly fine in the Move Specification Language (MSL).
Since the spec block uses the MSL language, its type system is different from that of Move.
In MSL, all integers are of type <code>num</code>, which is an integer in the mathematical sense. That is, it is signed and has no size limit.
All built-in integer types (<code>u8</code>, <code>u64</code>, etc.) are automatically converted to type <code>num</code> when referencing data in a Move program in MSL.
A more detailed description of the type system can be found in the MSL documentation.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="verify-the-transfer-function">Verify the <code>transfer</code> function<a class="hash-link" href="#verify-the-transfer-function" title="Direct link to heading">‚Äã</a></h2><p>The signature of the function <code>transfer</code> is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">public fun transfer&lt;CoinType: drop&gt;(from: &amp;signer, to: address, amount: u64, _witness: CoinType) acquires Balance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It is responsible for the transfer <code>from</code> the account from to the address <code>to</code>, and the transfer amount is <code>amount</code>.</p><p>Let&#x27;s ignore the abort condition for now and only consider its functional nature, and try to write its validation specification:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_from = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_to = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_from_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_to_post = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_to_post == balance_to + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here <code>from</code> is of type <code>signer</code>, not a direct address.
Although in the program we have created a local variable called <code>addr_from</code>, we cannot directly reference it in the spec block.
At the same time, the expression of this address needs to be repeated several times, and it is very cumbersome to write repeatedly. We bind it to <code>addr_from</code> again.
Then use <code>let</code> and <code>let post</code> to define several variables, corresponding to the balances in the two addresses <code>addr_from</code> and <code>to</code> before and after the function is executed.
Finally, use the <code>ensures</code> statement to tell Prover that the balance in <code>from</code> should be subtracted by <code>amount</code>; the balance in <code>to</code> should be increased by <code>amount</code>.</p><p>At first glance, there seems to be no problem at all. But is it really so?
Let&#x27;s see if Prover thinks this is &quot;the correct description of the behavior of this function&quot;.
After typing <code>mpm package prove</code> you can see:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">error: post-condition does not hold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îå‚îÄ ./sources/BasicCoin.move:58:9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">58 ‚îÇ         ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ‚îÇ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:45: transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:51: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:53: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:54: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:45: transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         from = signer{0x0}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         to = 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         amount = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         _witness = &lt;generic&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It is somewhat out of our expectation. Prover prompts that the postconditions are not satisfied, indicating that the behavior described in the previous spec block is not exactly the same as the <code>transfer</code> function.
Why is this so? Let&#x27;s look down again: the parameters that make the postconditions are not satisfied are <code>from = signer{0x0}</code> and <code>to = 0x0</code>. We should know the reason: when the account transfers money to itself, both <code>to</code> and <code>from</code> point to the same address, so the balance does not change.</p><p>There are two solutions now:</p><p><strong>Plan A</strong> does not modify the function definition, but changes the specification.
In the spec block, consider whether the two accounts for the transfer and receiving are the same address.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">let post eq_post = balance_to == balance_to_post;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let post ne_post = balance_from_post == balance_from - amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; balance_to_post   == balance_to   + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from == to &amp;&amp; eq_post) || (addr_from != to &amp;&amp; ne_post);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Or use another slightly more intuitive if syntax:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">let post eq_post = balance_to == balance_to_post;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let post ne_post = balance_from_post == balance_from - amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; balance_to_post   == balance_to   + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ensures if (addr_from == to) eq_post else ne_post;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that <code>if (P) E1 else E2</code> is not the same as conditional execution in program logic -- it&#x27;s actually a syntactic sugar equivalent to <code>ensures</code> both <code>P ==&gt; E1</code> and <code>!P ==&gt; E2</code>.
And <code>p ==&gt; q</code> is actually <code>!p || q</code>.</p><p>That is to say, the end of the second way of writing actually represents this logic:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from == to  ===&gt;  eq_post) &amp;&amp; (addr_from != to  ===&gt; ne_post);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>that is:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from != to || eq_post) &amp;&amp; (addr_from == to  || ne_post);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Interested readers can verify it by themselves through the direct value table or by simplifying to normal form, the former <code>(addr_from == to &amp;&amp; eq_post) || (addr_from != to &amp;&amp; ne_post)</code> and the latter <code>(addr_from != to || eq_post) &amp;&amp; (addr_from == to  || ne_post)</code> are actually exactly equivalent expressions.</p><p><strong>Plan B</strong> does not modify the spec, but directly adds <code>assert!(from_addr != to, EEQUAL_ADDR)</code> in the function body, and adds the definition of the error code <code>EEQUAL_ADDR</code> in front, so that the self-transfer transaction cannot be completed.</p><p>Obviously, it is not meaningful to transfer money to yourself, so it is better to directly prohibit this kind of transaction.
So plan B is a better practice.
It directly guarantees that the two are definitely not the same address when successfully executed, and the code is more concise.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="practice">practice<a class="hash-link" href="#practice" title="Direct link to heading">‚Äã</a></h3><p>Currently we have only completed functional verification of the <code>transfer</code> function.
But it doesn&#x27;t say under what circumstances it will abort.
As an exercise, give it an appropriate <code>aborts_if</code> condition. The answer can be found in later chapters. TODO</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="verify-mint-function">Verify mint function<a class="hash-link" href="#verify-mint-function" title="Direct link to heading">‚Äã</a></h2><p>The signature of the function <code>mint</code> is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">public fun mint&lt;CoinType: drop&gt;(mint_addr: address, amount: u64, _witness: CoinType) acquires Balance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It is responsible for minting the <code>amount</code> of tokens and depositing them in the address <code>mint_addr</code>.
More interesting is <code>_witness</code>, which is of type <code>CoinType</code>.
Because only the module that defines the <code>CoinType</code> can construct a value of this type, this guarantees the identity of the caller.</p><p>There is actually only one call to <code>deposit</code> in the <code>mint</code> function.
It is not difficult to imagine that there should be many similarities in the specifications to be satisfied by the two. Drawing a tiger according to a cat, it is not difficult to write:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec mint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(mint_addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(mint_addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(mint_addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="verify-the-publish_balance-function">Verify the <code>publish_balance</code> function<a class="hash-link" href="#verify-the-publish_balance-function" title="Direct link to heading">‚Äã</a></h2><p>The signature of the function <code>publish_balance</code> is as follows:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">public fun publish_balance&lt;CoinType&gt;(account: &amp;signer)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It publishes an empty <code>Balance&lt;CoinType&gt;</code> resource under <code>account</code>.
So if the resource already exists it should exit abnormally, and end normally the balance should be zero:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec publish_balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr = Signer::address_of(account);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="simplify-redundant-specification-with-schema">Simplify redundant specification with Schema<a class="hash-link" href="#simplify-redundant-specification-with-schema" title="Direct link to heading">‚Äã</a></h2><p>Congratulations! So far, we have completed the verification of all the functions of BasicCoin step by step.
However, if you look closely at the code, many of the spec blocks look very similar, and the file structure would be clearer if they could be shortened a bit.</p><p>Schema is a means of building a specification by grouping properties.
Semantically, they are also syntactic sugar, and their use in a spec block is equivalent to expanding the conditions they contain into functions, structs, or modules.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="eliminate-simple-repetitions">Eliminate simple repetitions<a class="hash-link" href="#eliminate-simple-repetitions" title="Direct link to heading">‚Äã</a></h3><p>As a most obvious example, the spec blocks of <code>mint</code> and <code>deposit</code> are a little different except for the variable names (in terms, they are <a href="https://en.wikipedia.org/wiki/Lambda_calculus#%CE%B1-conversion" target="_blank" rel="noopener noreferrer">alpha convertible</a>), and the overall structure can be said to be exactly the same.
To simplify them, let&#x27;s create a Schema:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec schema DepositSchema&lt;CoinType&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr: address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount: u64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This Schema declares two typed variables, and some conditions about what those variables should satisfy.
When other places want to use this Schema, use <code>include DepositSchema {addr: XX, amount: YY}</code> to import it.
where <code>XX</code> and <code>YY</code> are expressions used to replace <code>addr</code> and <code>amount</code>.
If the expression is exactly the same as the corresponding variable name, you can just write the variable name, or simply omit it.</p><p>With the above Schema definition, we can now simplify the previous spec:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec mint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  include DepositSchema&lt;CoinType&gt; {addr: mint_addr};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec deposit {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include DepositSchema&lt;CoinType&gt; {amount: check.value};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="schema-composition">Schema composition<a class="hash-link" href="#schema-composition" title="Direct link to heading">‚Äã</a></h3><p>Schema can not only eliminate the above almost the same repetition, but also can be combined to form a more complex specification.</p><p>If you experimented and completed the exercises through each step of the tutorial, the spec for your <code>tranfer</code> function should now look something like this:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// initial version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_from = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_to = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_from_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_to_post = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr_from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(to);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance_from &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance_to + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if addr_from == to;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_to_post == balance_to + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Although it is relatively complicated, it is not difficult to see after a little analysis that it actually combines the two logics of <code>withdraw</code> and <code>deposit</code>.
This can also be analyzed from the calling relationship of transfer.</p><p>In the previous step, we already have <code>DepositSchema</code>. Now, let&#x27;s refactor the validation specification for <code>withdraw</code>: extract it into a Schema, and a spec block that uses the Schema:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include WithdrawSchema&lt;CoinType&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures result == Coin&lt;CoinType&gt; { value: amount };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec schema WithdrawSchema&lt;CoinType&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr: address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount: u64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With these two schemas, we can easily rewrite the validation specification of <code>transfer</code>:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">// After refactoring with Schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include WithdrawSchema&lt;CoinType&gt; { addr: addr_from };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include DepositSchema&lt;CoinType&gt; { addr: to };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if addr_from == to;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>how about it? Compared with the original version, it is much simpler and clearer now.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="practice-1">practice<a class="hash-link" href="#practice-1" title="Direct link to heading">‚Äã</a></h3><p>In addition to the above example, find another spec block (such as <code>publish_balance</code>), and split it into a Schema declaration and a spec block that uses the corresponding Schema.
As an exercise, the Schema you created might not be available in this code, so it doesn&#x27;t feel like there&#x27;s much benefit to it.
But if in the later development, there are other functions that call <code>publish_balance</code>, it will be more convenient.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/starcoinorg/starcoin-cookbook/edit/main/docs/03-move/100-move-prover/02-mvp-tutorial.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/starcoin-cookbook/docs/move/move-prover/move-spec-language"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Move Specification Language</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/starcoin-cookbook/docs/web3/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How to build DApp on Starcoin</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-move-prover" class="table-of-contents__link toc-highlight">What is Move Prover</a></li><li><a href="#install-prover-dependencies" class="table-of-contents__link toc-highlight">Install Prover dependencies</a></li><li><a href="#prepare-an-example-for-verification" class="table-of-contents__link toc-highlight">Prepare an example for verification</a><ul><li><a href="#project-creation" class="table-of-contents__link toc-highlight">Project creation</a></li><li><a href="#module-code" class="table-of-contents__link toc-highlight">Module code</a></li><li><a href="#toml-configuration" class="table-of-contents__link toc-highlight">TOML configuration</a></li></ul></li><li><a href="#the-first-verification-code" class="table-of-contents__link toc-highlight">The first verification code</a></li><li><a href="#verify-withdraw-function" class="table-of-contents__link toc-highlight">Verify withdraw function</a><ul><li><a href="#specify-the-abort-condition-for-widthdraw" class="table-of-contents__link toc-highlight">Specify the abort condition for <code>widthdraw</code></a></li><li><a href="#specify-the-functional-nature-of-withdraw" class="table-of-contents__link toc-highlight">Specify the functional nature of <code>withdraw</code></a></li></ul></li><li><a href="#verify-the-deposit-function" class="table-of-contents__link toc-highlight">Verify the <code>deposit</code> function</a></li><li><a href="#verify-the-transfer-function" class="table-of-contents__link toc-highlight">Verify the <code>transfer</code> function</a><ul><li><a href="#practice" class="table-of-contents__link toc-highlight">practice</a></li></ul></li><li><a href="#verify-mint-function" class="table-of-contents__link toc-highlight">Verify mint function</a></li><li><a href="#verify-the-publish_balance-function" class="table-of-contents__link toc-highlight">Verify the <code>publish_balance</code> function</a></li><li><a href="#simplify-redundant-specification-with-schema" class="table-of-contents__link toc-highlight">Simplify redundant specification with Schema</a><ul><li><a href="#eliminate-simple-repetitions" class="table-of-contents__link toc-highlight">Eliminate simple repetitions</a></li><li><a href="#schema-composition" class="table-of-contents__link toc-highlight">Schema composition</a></li><li><a href="#practice-1" class="table-of-contents__link toc-highlight">practice</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/starcoin-cookbook/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discor.gg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://t.me/starcoin_contributor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Developer Telegram group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/StarcoinSTC" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Starcoin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/starcoin-cookbook/assets/js/runtime~main.0760d43c.js"></script>
<script src="/starcoin-cookbook/assets/js/main.7e346ee4.js"></script>
</body>
</html>