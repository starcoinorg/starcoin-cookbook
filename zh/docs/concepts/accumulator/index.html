<!doctype html>
<html class="docs-version-current" lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<title data-rh="true">Accumulator | Starcoin Cookbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/accumulator"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Accumulator | Starcoin Cookbook"><meta data-rh="true" name="description" content="ä»‹ç» Accumulator ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ Merkle Treeã€‚"><meta data-rh="true" property="og:description" content="ä»‹ç» Accumulator ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ Merkle Treeã€‚"><link data-rh="true" rel="icon" href="/starcoin-cookbook/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/accumulator"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/concepts/accumulator" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/accumulator" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/concepts/accumulator" hreflang="x-default"><link rel="stylesheet" href="/starcoin-cookbook/zh/assets/css/styles.0778a76e.css">
<link rel="preload" href="/starcoin-cookbook/zh/assets/js/runtime~main.46521177.js" as="script">
<link rel="preload" href="/starcoin-cookbook/zh/assets/js/main.da5c0ce0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">è·³åˆ°ä¸»è¦å†…å®¹</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/starcoin-cookbook/zh/"><div class="navbar__logo"><img src="/starcoin-cookbook/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/starcoin-cookbook/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Starcoin Cookbook</b></a><a class="navbar__item navbar__link navbar__link--active" href="/starcoin-cookbook/zh/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/starcoin-cookbook/docs/concepts/accumulator" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/starcoin-cookbook/zh/docs/concepts/accumulator" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">ä¸­æ–‡</a></li></ul></div><a href="https://github.com/starcoinorg/starcoin-cookbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="åˆ‡æ¢æµ…è‰²/æš—é»‘æ¨¡å¼ï¼ˆå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ï¼‰"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="å›åˆ°é¡¶éƒ¨" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/starcoin-cookbook/zh/docs/intro">Starcoin CookBook Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/starcoin-cookbook/zh/docs/getting-started/install/">å…¥é—¨</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/starcoin-cookbook/zh/docs/move/">Move å’Œæ™ºèƒ½åˆçº¦å¼€å‘</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒMove å’Œæ™ºèƒ½åˆçº¦å¼€å‘ã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/starcoin-cookbook/zh/docs/web3/">Web3 and DApp Development</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒWeb3 and DApp Developmentã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/starcoin-cookbook/zh/docs/reference/">Reference</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒReferenceã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/starcoin-cookbook/zh/docs/concepts/merkletree">Concepts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/merkletree">Merkle Tree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/account">è´¦å·</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/transaction">äº¤æ˜“</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/block">åŒºå—</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/state">çŠ¶æ€</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/smt">Sparse Merkle Tree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/accumulator">Accumulator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/proof">Proof</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/starcoin-cookbook/zh/docs/miscellaneous/contributing">æ‚é¡¹</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/starcoin-cookbook/zh/">ğŸ </a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">Concepts</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/starcoin-cookbook/zh/docs/concepts/accumulator">Accumulator</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">æœ¬é¡µæ€»è§ˆ</button></div><div class="theme-doc-markdown markdown"><h1>Accumulator</h1><p>ä»‹ç» Accumulator ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ <a href="/starcoin-cookbook/zh/docs/concepts/merkletree">Merkle Tree</a>ã€‚
åœ¨ Starcoin ä¸­ï¼ŒAccumulator å¯ä»¥è®¤ä¸ºæ˜¯ Merkle Tree å­˜å‚¨åœ¨ KvStore ä¸Šã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ç”¨é€”">ç”¨é€”<a class="hash-link" href="#ç”¨é€”" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>è¿™é¢—æ ‘çš„ä½œç”¨ä¸»è¦æ˜¯æä¾› Blockï¼ŒTransaction çš„ Merkle Proofï¼Œä»¥åŠé€šè¿‡æŒ‡åºåˆ—å·è·å–å¯¹åº”çš„ Blockï¼ˆ Transaction ç±»ä¼¼ï¼‰ã€‚
ä¸‹é¢ä»‹ç»ä¸‹åœ¨ Starcoin ä¸­ Accumulator çš„ä¸€äº›ä¿¡æ¯ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="èŠ‚ç‚¹ç±»å‹ä»‹ç»">èŠ‚ç‚¹ç±»å‹ä»‹ç»<a class="hash-link" href="#èŠ‚ç‚¹ç±»å‹ä»‹ç»" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç§ç±»å‹ Leafï¼ŒInternalï¼ŒEmptyã€‚
è¿™é‡Œä»¥å­˜å‚¨ Block ä¸ºä¾‹å­ï¼ˆå­˜å‚¨ Transactionç±»ä¼¼ï¼‰ã€‚
å›¾1æ˜¾ç¤ºäº†å¶æ•°ä¸ª Block ç»„æˆä¸€ä¸ª Accumulator çš„æƒ…å†µï¼ˆè¿™é‡Œåªæœ‰ Leaf å’Œ Internalï¼‰</p><p><img loading="lazy" alt="even_accumulator.png" src="/starcoin-cookbook/zh/assets/images/even_accumulator-1e65bd4c8c5631c0762330cf13778014.png" width="626" height="501"></p><p>æœ€ä¸‹é¢ Leaf é‚£å±‚çš„ Hash0 ä»£è¡¨ Block0 çš„ Hash å€¼ï¼ŒHash1 ä»£è¡¨ Block1 çš„å€¼ï¼Œ Hash2ï¼ŒHash3 ç±»ä¼¼ã€‚
è¿™é‡Œ Internal01 çš„å·¦å­æ ‘æ˜¯ Hash0ï¼Œå³å­æ ‘æ˜¯ Hash1ã€‚
Internal 01 çš„ Hash01 = Hash(Hash0 + Hash1)ï¼Œ+ ä»£è¡¨æ‹¼æ¥å­—ç¬¦ä¸²ã€‚
åœ¨ Accumulator ä¸­ Internal èŠ‚ç‚¹çš„ Hash å€¼è®¡ç®—æ–¹æ³•æ˜¯å·¦å­æ ‘ Hash å€¼å’Œå³å­æ ‘ Hash å€¼æ‹¼æ¥åå† Hash è®¡ç®—ä¸‹ï¼ŒHash è®¡ç®—çš„å‡½æ•°æ˜¯ sha3_256ã€‚
è¿™é‡Œä» Block0 å¼€å§‹æ˜¯å› ä¸ºåœ¨åŒºå—é“¾ä¸­æœ‰åˆ›ä¸–å—ï¼ˆGenesis Blockï¼‰ï¼Œæœ€ä¸Šé¢çš„æ ¹èŠ‚ç‚¹å«åš Root_Hashã€‚</p><p><img loading="lazy" alt="odd_accumulator_origin.png" src="/starcoin-cookbook/zh/assets/images/odd_accumulator_origin-923bb20aba3c4082cb67f517eae86ef0.png" width="831" height="546"></p><p>å›¾2æ˜¾ç¤ºäº†å¥‡æ•°ä¸ª Block ç»„æˆä¸€ä¸ª Accumulator çš„æƒ…å†µï¼Œåœ¨å›¾1åŸºç¡€ä¸Šæ·»åŠ äº† Block4ï¼Œç”±äº Block4 æ„å»º Internal éœ€è¦ Empty èŠ‚ç‚¹æ¥é…å¯¹ï¼Œè¿™é‡Œ Empty èŠ‚ç‚¹å°±æ˜¯ PlaceHolderã€‚
è¿™ç§æƒ…å†µä¸‹è¦è¡¥å……å¤šä¸ª PlaceHolderï¼Œè¿™é‡Œåšäº†äº›ä¼˜åŒ–ï¼Œç©ºå­æ ‘ç”¨ PlaceHolder è¡¨ç¤ºæ¥å‡å°‘è®¡ç®—ï¼Œ è¿™é‡Œ PlaceHolder æœ‰å›ºå®šçš„ Hash å€¼ ACCUMULATOR_PLACEHOLDER_HASHï¼Œå¦‚å›¾3ã€‚</p><p><img loading="lazy" alt="odd_accumulator.png" src="/starcoin-cookbook/zh/assets/images/odd_accumulator-7608b4d1d8ac2f8e44ab1637feb1f920.png" width="711" height="551"></p><p>å›¾3ä¸­ï¼Œ<code>(Hash(Block), Block)</code> ä¼šæŒ‰ç…§ Key Value é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨ KvStore ä¸­ã€‚
è¿™é‡Œç»™å‡ºä»£ç ä¸­ Leaf å’Œ Internal çš„å®šä¹‰</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pub enum AccumulatorNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Internal(InternalNode),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Leaf(LeafNode),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Empty,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct InternalNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index: NodeIndex,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    left: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    right: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_frozen: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct LeafNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    index: NodeIndex,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hash: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>è¿™é‡Œ index å’Œ is_frozen åœ¨ Internal å’Œ Leaf ä¸­éƒ½ä¸å‚ä¸Hashè®¡ç®—ï¼Œ NodeIndex ä¸»è¦ç”¨é€”æ˜¯ Accumulator å­˜å‚¨åœ¨ KvStore ä¸­è®¡ç®— Internal ç”¨åˆ°ï¼Œåé¢ä¼šä»‹ç»ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="èŠ‚ç‚¹çš„frozen">èŠ‚ç‚¹çš„Frozen<a class="hash-link" href="#èŠ‚ç‚¹çš„frozen" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>Merkle Tree æ˜¯åœ¨å†…å­˜ä¸­çš„å½¢å¼, Accumulator éœ€è¦æŠŠ Merkle Tree ä¿å­˜åœ¨ KvStore ä¸­ã€‚
ä¸€ç§ç›´è§‚çš„æƒ³æ³•å°±æ˜¯æŠŠæŠŠæ‰€æœ‰çš„ Leaf èŠ‚ç‚¹ä¿å­˜ä¸‹æ¥ï¼Œæ¯”å¦‚å›¾3ä¸­ï¼Œä¿å­˜ Hash0ï¼ŒHash1ï¼Œ Hash2ï¼Œ Hash3ï¼Œ Hash4ï¼Œè¿˜éœ€è¦ä¿å­˜è¿™äº›é¡ºåºå…³ç³»ã€‚
ç¬¬ä¸€æ¬¡ç”¨çš„æ—¶å€™è®¡ç®—å°±å¯ä»¥æ„å»º Merkle Treeï¼Œå›¾3ä¸­éœ€è¦è®¡ç®—6æ¬¡ï¼Œ
å½“ Leaf æ•°é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚<code>2^23</code>ä¸ª Leaf (å¤§æ¦‚800ä¸‡ä¸ªBlock)ï¼Œéœ€è¦<code>2^23</code>æ¬¡ sha3_256 è®¡ç®—ï¼Œè¿™ä¸ªå¤æ‚åº¦æ˜¯O(N)ã€‚
éœ€è¦åŠ é€Ÿä¸‹è®¡ç®—çš„è¿‡ç¨‹ï¼Œæ³¨æ„åˆ° Accumulator æ˜¯åªæ·»åŠ  Leaf ä¸ä¼šå‡ºç°åˆ é™¤å’Œæ›´æ–°Leafçš„æƒ…å†µï¼Œ
æ¯”å¦‚åœ¨å›¾3ä¸­ï¼ŒHash0ï¼ŒHash1ï¼ŒHash2ï¼ŒHash3 æ„å»ºæˆçš„å­ Accumulator æ˜¯ Hash(Hash01 + Hash23)ï¼Œ å†æ·»åŠ æ–°çš„ Leafï¼Œä¸ä¼šä¿®æ”¹æ ¹èŠ‚ç‚¹ Hash(Hash01 + Hash23) çš„ Accumulatorã€‚
å¯ä»¥åŸºäºè¿™äº›å·²ç»å›ºå®šçš„å­ Accumulator è¿›è¡ŒåŠ é€Ÿè®¡ç®—ã€‚å¯ä»¥å‘ç°å›ºå®šçš„å­ Accumulator éƒ½æ˜¯æ»¡äºŒå‰æ ‘(Full Binary Tree)ã€‚
è¿™é‡Œå¼•å…¥äº† Frozen çš„æ¦‚å¿µã€‚
PlaceHolder æ˜¯not Frozen çš„ï¼Œ Leaf éƒ½æ˜¯ Frozen çš„ï¼ŒInternal çš„ Frozen æ˜¯é€’å½’å®šä¹‰ï¼Œæ˜¯æŒ‡å·¦å­æ ‘å’Œå³å­æ ‘ä¸­ä¸å«æœ‰ PlaceHolder èŠ‚ç‚¹ã€‚
ä¸€ä¸ª Accumulator ä¸­èŠ‚ç‚¹æ•°ç›®æŒ‡æ‰€æœ‰ Frozen çš„èŠ‚ç‚¹,åœ¨å›¾1ä¸­æ˜¯7ä¸ªï¼Œå›¾3ä¸­æ˜¯8ä¸ªã€‚
ä¸€ä¸ª Accumulator å¯ä»¥é€šè¿‡ Root_Hash å’Œ frozen_subtree_roots å¿«é€Ÿç¡®å®šä¸‹æ¥ã€‚
è¿™é‡Œå®šä¹‰äº† AccumulatorInfoï¼Œå¦‚ä¸‹æ‰€ç¤º</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pub struct AccumulatorInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Accumulator root hash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub accumulator_root: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Frozen subtree roots of this accumulator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub frozen_subtree_roots: Vec&lt;HashValue&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The total number of leaves in this accumulator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub num_leaves: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The total number of nodes in this accumulator.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub num_nodes: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>åœ¨å›¾1ä¸­ frozen_subtree_roots å…ƒç´ åªæœ‰ä¸€ä¸ªå°±æ˜¯ Root_Hash ( accumulator_root )ã€‚
å›¾3ä¸­æœ‰2ä¸ªéƒ½æ ‡å‡ºæ¥äº†,ä»–ä»¬å’Œ Root_Hash ä¸åŒã€‚
è¿™é‡Œ frozen_subtree_roots æœ€å¤šåªæœ‰64ä¸ªã€‚
åŸå› å¦‚ä¸‹ï¼Œå‡è®¾æœ‰nä¸ªèŠ‚ç‚¹ï¼Œå‡è®¾ <code>2^k &lt;= n &lt; 2^(k + 1)</code>ï¼Œ ç¬¬ä¸€ä¸ª frozen_subtree ç”¨çš„èŠ‚ç‚¹æ•°æ˜¯<code>2^k</code>ï¼Œç¬¬äºŒä¸ªçš„ frozen_subtree ç”¨çš„èŠ‚ç‚¹æ•°æ˜¯ <code>2^k1</code>ï¼Œ
å…¶ä¸­ <code>2^k1 &lt;= (n - 2^k) &lt; 2^(k1 + 1)</code>ï¼Œ å¯ä»¥å‘ç° frozen_subtree_roots å’Œ n çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„1æ˜¯å¯¹åº”çš„ï¼Œç”±äº n å®šä»¥ä¸º64ä½æ•´æ•°ï¼Œæœ€å¤šæœ‰64ä¸ªèŠ‚ç‚¹æ•°ã€‚
HashValue ä½¿ç”¨ sha3_256 è®¡ç®—å 8ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ª AccumulatorInfo å çš„å†…å­˜æœ€å¤§æ˜¯<code>(1 + 64 + 2) * 8</code>ä¸ªå­—èŠ‚ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="leaf-index-å’Œ-node-index">Leaf Index å’Œ Node Index<a class="hash-link" href="#leaf-index-å’Œ-node-index" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>å¦‚å›¾1ä¸­ï¼ŒHash0-Hash3 æ˜¯ Merkle Tree çš„ Leaf èŠ‚ç‚¹ï¼Œä»–ä»¬åˆ†åˆ«å¯¹åº”<code>0-3</code>çš„ Leaf èŠ‚ç‚¹(è®¡æ•°ä»0å¼€å§‹)
Leaf Index å°±æ˜¯ä»å·¦å¼€å§‹ Leaf èŠ‚ç‚¹çš„é¡ºåºã€‚Node Index æ˜¯ä¸­åºéå† Tree çš„å„ä¸ªèŠ‚ç‚¹çš„é¡ºåºï¼ŒHash0-Hash3 å¯¹åº”çš„ Node Index æ˜¯<code>0,2,4,6</code>ã€‚
ç®€ç•¥å›¾å¦‚ä¸‹</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /  </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /    </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Node Index, </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> order transver</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> / </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">    / </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Leaf Index</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>Node Index åœ¨ä»£ç ä¸­è¡¨ç¤ºä¸º NodeIndex ã€‚
è¿™é‡Œä½¿ç”¨ä¸­åºéå†çš„åŸå› å¯èƒ½æ˜¯ Accumulator éœ€è¦å°† Merkle Tree ä¿å­˜åˆ° KvStore ä¸­ï¼Œç”±äºä¿å­˜çš„éƒ½æ˜¯ HashValueï¼Œéœ€è¦çŸ¥é“ HashValue åœ¨ Merkle Tree ä¸­çš„ä½ç½®
å›¾3åœ¨å›¾1åŸºç¡€ä¸Šæ·»åŠ ä¸€ä¸ª Hash4 çš„èŠ‚ç‚¹ï¼Œä¸­åºéå†æƒ…å†µä¸‹å„ä¸ªèŠ‚ç‚¹çš„ NodeIndex å€¼æ˜¯ä¸å˜çš„ã€‚</p><p>ä¸‹é¢ä»‹ç»ä¸‹ Accumulator çš„ä¸€äº›æ“ä½œè¿‡ç¨‹</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="accumulator-append-è¿‡ç¨‹">Accumulator append è¿‡ç¨‹<a class="hash-link" href="#accumulator-append-è¿‡ç¨‹" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn append(&amp;mut self, new_leaves: &amp;[HashValue]) -&gt; Result&lt;HashValue&gt;</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>ä¸Šé¢æ˜¯å¯¹åº”çš„ä»£ç </p><p><img loading="lazy" alt="accumulator_store.png" src="/starcoin-cookbook/zh/assets/images/accumulator_store-43d4715401ff80b8d3d9591ae241d2f7.png" width="831" height="761">
æµç¨‹åˆ†ä¸ºèŠ‚ç‚¹çš„æ·»åŠ å’Œæ ¹èŠ‚ç‚¹çš„è®¡ç®—</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ–°èŠ‚ç‚¹æ·»åŠ ">æ–°èŠ‚ç‚¹æ·»åŠ <a class="hash-link" href="#æ–°èŠ‚ç‚¹æ·»åŠ " title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>å¦‚å›¾4ä¸­ï¼ŒHash0-Hash3 æ„å»ºçš„ Accumulator çš„ Root_Hash ä¸º Hash(Internal0123)ï¼Œ ç°åœ¨æ·»åŠ  Hash4-Hash6ã€‚
æ·»åŠ  Hash4 LeafNodeï¼Œ Hash4 æ·»åŠ åˆ° to_freezeï¼Œ<code>to_freeze = [Hash4]</code>ï¼ŒHash4 ä¸ºå·¦å­©å­èŠ‚ç‚¹ï¼ŒHash4 æ·»åŠ å®Œæˆã€‚
æ·»åŠ  Hash5 LeafNodeï¼Œ Hash5 æ·»åŠ åˆ° to_freezeï¼Œ <code>to_freeze = [Hash4, Hash5]</code>, Hash5 ä¸ºå³å­©å­èŠ‚ç‚¹ï¼Œéœ€è¦å’Œå…¶å…„å¼ŸèŠ‚ç‚¹( sibling )ç”Ÿæˆä¸€ä¸ª Frozen çš„ Internal 45,
å¹¶ä¸”æ·»åŠ åˆ° to_freezeï¼Œ <code>to_freeze = [Hash4, Hash5, Internal45]</code>ï¼Œ è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ªæŸ¥è¯¢ sibling æ“ä½œï¼Œåé¢ä¼šä»‹ç»ï¼Œ Hash5 æ·»åŠ å®Œæˆã€‚
æ·»åŠ  Hash6 LeafNodeï¼Œ Hash6 æ·»åŠ åˆ° to_freezeï¼Œ<code>to_freeze = [Hash4, Hash5, Internal45, Hash6]</code>, Hash6 ä¸ºä¸€ä¸ªå·¦å­©å­èŠ‚ç‚¹ï¼ŒHash6 æ·»åŠ å®Œæˆã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ ¹èŠ‚ç‚¹çš„è®¡ç®—">æ ¹èŠ‚ç‚¹çš„è®¡ç®—<a class="hash-link" href="#æ ¹èŠ‚ç‚¹çš„è®¡ç®—" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>æ ¹èŠ‚ç‚¹çš„è®¡ç®—ä¼šéœ€è¦ç”¨åˆ°<code>NodeIndex, HashValue</code>çš„æ˜ å°„ï¼Œå°±æ˜¯ä¸‹é¢æåˆ° index_cacheã€‚
éœ€è¦è®¡ç®—ä¸‹ç”Ÿæˆçš„æ–° Root_Hash å€¼ï¼ŒHash6 å’Œ PlaceHolder ç”Ÿæˆ Not Frozen Node Internal67ï¼Œ æ·»åŠ åˆ° not_freezeï¼Œ <code>not_freeze = [Internal67]</code>ï¼Œ
Internal67 å’Œå…¶ sibling èŠ‚ç‚¹ Internal45 (è¿™é‡Œä¼šäº§ç”ŸæŸ¥è¯¢æ“ä½œ) ç”Ÿæˆ Not Frozen Node Internal4567  æ·»åŠ åˆ° not_freezeï¼Œ<code>not_freeze = [Internal67, Internal4567]</code>ï¼Œ è¿™é‡Œä¼šæœ‰ä¸ªæŸ¥è¯¢èŠ‚ç‚¹æ“ä½œï¼Œ
Internal4567 å’Œå…¶ sibling èŠ‚ç‚¹ Internal0123 (è¿™é‡Œä¼šäº§ç”ŸæŸ¥è¯¢æ“ä½œ) ç”Ÿæˆä¸€ä¸ª Not Frozen Node Internal01234567ï¼Œ
æ·»åŠ åˆ°not_freezeï¼Œ <code>not_freeze = [Internal67, Internal4567, Internal01234567]</code>ï¼Œ <code>Hash(Internal01234567)</code>æ˜¯æ–°çš„ Root_Hashã€‚
Starcoinå®ç°ä¸­ä¼šå°† to_freeze, not_freeze åˆå¹¶èµ·æ¥ï¼Œå¹¶æ„å»º<code>LruCache&lt;NodeIndex, HashValue&gt;</code>ï¼Œ è¿™ä¸ªç§°ä¸º index_cache , æŸ¥è¯¢ä¸­ä¼šç”¨åˆ°
å›¾4ä¸­ NodeIndex ç”¨è“è‰²è¡¨ç¤ºã€‚
<code>index_cache = [(8, Hash4), (10, Hash5), (9, Hash45), (13, Hash(Internal67)), (11, Hash(Internal4567)), (7, HashInternal(Internal01234567))]</code>ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="accumulator-flush-å’Œ-accumulator-åœ¨-kvstore-ä¸­çš„å­˜å‚¨">Accumulator flush å’Œ Accumulator åœ¨ KvStore ä¸­çš„å­˜å‚¨<a class="hash-link" href="#accumulator-flush-å’Œ-accumulator-åœ¨-kvstore-ä¸­çš„å­˜å‚¨" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn flush(&amp;mut self) -&gt; Result&lt;()&gt; </span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>å°† append è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ to_freeze å’Œ not_free åˆå¹¶åæŒ‰ç…§<code>(Hash(Node), encode(Node))</code> Key Value é”®å€¼å¯¹å½¢å¼å­˜å‚¨åœ¨ KvStore ä¸­ã€‚
åœ¨å›¾4ä¸­ä½¿ç”¨çš„æ˜¯ Column BLOCK_ACCUMULATORï¼Œå®é™…è¿˜æœ‰ Transaction å¯¹åº”çš„ Column TRANSACTION_ACCUMULATORï¼Œå›¾ä¸­åªç”»äº†éƒ¨åˆ† Leafï¼ŒInternalã€‚
æ³¨æ„åˆ° Internal åˆ†ä¸º Frozen å’Œ Not Frozenï¼Œ å›¾4ä¸­ Internal 67è¿™ä¸ª Internal èŠ‚ç‚¹æ˜¯ Not Frozen çš„ï¼Œå¦‚æœå†æ·»åŠ ä¸€ä¸ªæ–°çš„ Leaf Hash7ä¼šå˜æˆ Frozenï¼Œ è¿™æ ·ä¼šä¿å­˜
ä¸¤ä¸ªä¸åŒçŠ¶æ€çš„ Internal67 åˆ° KvStoreã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="æŸ¥è¯¢æ“ä½œ">æŸ¥è¯¢æ“ä½œ<a class="hash-link" href="#æŸ¥è¯¢æ“ä½œ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fn get_node_hash_always(&amp;mut self, index: NodeIndex) -&gt; Result&lt;HashValue&gt;</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>è¿™æ˜¯ä¸ª private æ“ä½œï¼Œä¸»è¦ç”¨åœ¨ append æµç¨‹ä¸­ï¼Œé€šè¿‡ NodeIndex æŸ¥æ‰¾å¯¹åº”çš„ HashValueã€‚
Accumulator åœ¨ KvStore ä¸­çš„å­˜å‚¨ä¸­æåˆ°ï¼ŒColumn BLOCK_ACCUMULATOR ä¿å­˜æ˜¯æŒ‰ç…§<code>(Hash(Node)ï¼Œencode(Node))</code> Key Value é”®å€¼å¯¹å­˜å‚¨åœ¨ KvStore ä¸­ï¼Œ
åªèƒ½ä»å…¶çˆ¶ç±»èŠ‚ç‚¹ä¸€å±‚å±‚æŸ¥æ‰¾ï¼Œæ¯”å¦‚æŸ¥è¯¢ NodeIndex x0 (å‡è®¾ä¸º2)çš„ HashValueï¼ŒæŸ¥ NodeIndex x1 (å‡è®¾ä¸º1)çš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœ index_cache ä¸­æœ‰ï¼Œé€šè¿‡å…¶ HashValue ä» KvStore ä¸­è·å–è¿™ä¸ª Nodeï¼Œå¦‚æœ
index_cache ä¸­æ²¡æœ‰ï¼Œæ‰¾å…¶çˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œæœ€ç»ˆè‚¯å®šèƒ½æ‰¾åˆ°(æœ€å·®çš„æƒ…å†µæ˜¯æ‰¾åˆ° Root_Hash ), è¿™ä¸ªèŠ‚ç‚¹è®°ä¸º Cur_Node , ç„¶åå†ä» Cur_Node å±‚æ¬¡éå†æ‰¾åˆ°å­å­™èŠ‚ç‚¹ä¸­ NodeIndex ç­‰äº x0 çš„èŠ‚ç‚¹ã€‚
æµç¨‹å›¾è§å›¾5</p><p><img loading="lazy" alt="query_index.png" src="/starcoin-cookbook/zh/assets/images/query_index-7717e571607d64a2671279259bb9ab26.png" width="600" height="541"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="accumulator-çš„å¹‚ç­‰æ€§">Accumulator çš„å¹‚ç­‰æ€§<a class="hash-link" href="#accumulator-çš„å¹‚ç­‰æ€§" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p>åœ¨ Merkle Tree ä¸­æåˆ°è®°ä½ Root_Hash å°±å¯ä»¥è®¤ä¸ºæ˜¯è®°ä½äº†æ•´æ£µæ ‘, åœ¨ Starcoin ä¸­ï¼Œéœ€è¦ä¿è¯ Accumulator æ˜¯å¹‚ç­‰çš„ã€‚
æ¯”å¦‚åœ¨å›¾3ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ‰§è¡Œäº† Block0-4 çš„è®¡ç®—ï¼Œè¿™æ—¶å€™åˆæœ‰é€»è¾‘æŠŠ Block4 æ·»åŠ è¿›æ¥è®¡ç®—ï¼Œè¿™æ—¶å€™ä¼šä¸ä¼šå‡ºç°æ·»åŠ  Block5 å®é™…æ˜¯ Block4 çš„é€»è¾‘ï¼Œå®é™…ä¸Šä¸ä¼šï¼Œç”±äº Block çš„ BlockHeader å­˜å‚¨äº†å‰ä¸€ä¸ª Block çš„ Hash å€¼ï¼Œ
é€šè¿‡å‰ä¸€ä¸ª Hash å€¼å°±çŸ¥é“æ•´ä¸ª Accumulator çš„ Leaf æ•°ç›®ä¸º4ï¼Œå¯¹åº”çš„å­ Accumulator çš„ Hash å€¼æ˜¯ Hash(Hash01 + Hash23),ä¼šå’Œ Hash(Block4) è®¡ç®—æ–°çš„ Accumulatorï¼Œè¿™éƒ¨åˆ†éœ€è¦ç»“åˆåŒºå—æ‰§è¡Œæ¥ç†è§£ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="accumulator-ä¸­apiè¯´æ˜">Accumulator ä¸­APIè¯´æ˜<a class="hash-link" href="#accumulator-ä¸­apiè¯´æ˜" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="åˆ›å»º-accumulator">åˆ›å»º Accumulator<a class="hash-link" href="#åˆ›å»º-accumulator" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pub struct MerkleAccumulator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tree: Mutex&lt;AccumulatorTree&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl MerkleAccumulator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub fn new_with_info(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acc_info: AccumulatorInfo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node_store: Arc&lt;dyn AccumulatorTreeStore&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) -&gt; Self;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>new_with_info é€šè¿‡ AccumulatorInfo åˆ›å»ºæ–°çš„ Accumulator</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ·»åŠ æ–°çš„å…ƒç´ ">æ·»åŠ æ–°çš„å…ƒç´ <a class="hash-link" href="#æ·»åŠ æ–°çš„å…ƒç´ " title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> fn append(&amp;self, leaves: &amp;[HashValue]) -&gt; Result&lt;HashValue&gt;</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>æ·»åŠ æ–°çš„ LeafNodeï¼Œè¿™ä¸ªå‰é¢ä»‹ç»è¿‡</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ä¿å­˜æ ‘åˆ°-kvstore">ä¿å­˜æ ‘åˆ° KvStore<a class="hash-link" href="#ä¿å­˜æ ‘åˆ°-kvstore" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> fn flush(&amp;self) -&gt; Result&lt;()&gt;;</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>å°† append äº§ç”Ÿçš„æ–°å…ƒç´ å­˜åˆ° KvStore</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="è·å–å¶å­èŠ‚ç‚¹">è·å–å¶å­èŠ‚ç‚¹<a class="hash-link" href="#è·å–å¶å­èŠ‚ç‚¹" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fn get_leaf(&amp;self, leaf_index: u64) -&gt; Result&lt;Option&lt;HashValue&gt;&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn get_leaves(&amp;self, start_index: u64, reverse: bool, max_size: u64) -&gt; Result&lt;Vec&lt;HashValue&gt;&gt;;</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>ç¬¬ä¸€ä¸ªæ˜¯è·å–å¶å­èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªæ˜¯æ‰¹é‡è·å–å¶å­èŠ‚ç‚¹</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="è·å–proof">è·å–proof<a class="hash-link" href="#è·å–proof" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">fn get_proof(&amp;self, leaf_index: u64) -&gt; Result&lt;Option&lt;AccumulatorProof&gt;&gt; {</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>è·å–Merkle Proofè¯æ˜</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="å…¶ä»–çç¢ç»†èŠ‚">å…¶ä»–çç¢ç»†èŠ‚<a class="hash-link" href="#å…¶ä»–çç¢ç»†èŠ‚" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="append-è¿‡ç¨‹ä¸­çš„è·å–-frozen_subtree_roots">append è¿‡ç¨‹ä¸­çš„è·å– frozen_subtree_roots<a class="hash-link" href="#append-è¿‡ç¨‹ä¸­çš„è·å–-frozen_subtree_roots" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FrozenSubTreeIterator::new(self.num_leaves)</span><br></span></code></pre><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" class="copyButton_wuS7 clean-btn">å¤åˆ¶</button></div></div><p>è¿™é‡Œæ˜¯å› ä¸º frozen_subtree å’Œ num_leaves äºŒè¿›åˆ¶é‡Œçš„çš„1å¯¹åº”ï¼Œ å°±æ˜¯æ‰¾MSBæ“ä½œ(most significant set bit of a u64), åŸç†å‚è€ƒ Hackers Delight çš„ flp éƒ¨åˆ†</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="nodeindex-ç›¸å…³æ“ä½œ">NodeIndex ç›¸å…³æ“ä½œ<a class="hash-link" href="#nodeindex-ç›¸å…³æ“ä½œ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>å¦‚æœä¸æƒ³ç ”ç©¶ NodeIndex æºç ï¼Œè¿™éƒ¨åˆ†å¯ä»¥ä¸çœ‹
NodeIndex æä¾›äº†ä¸€äº›æ“ä½œ
(1)é€šè¿‡ LeafCount è®¡ç®—æ•´ä¸ªæ ‘é«˜
(2)Leaf Index å’Œ NodeIndex çš„è½¬æ¢
(3)è·å–å·¦å­æ ‘å’Œå³å­æ ‘ NodeIndex
(4)ç¡®å®šæŸä¸ª NodeIndex æ˜¯å¦ä¸º PlaceHolder
(5)è·å–çˆ¶èŠ‚ç‚¹çš„ NodeIndex
è¿™éƒ¨åˆ†ç»†èŠ‚å¾…æ·»åŠ ã€‚</p><p>ç›¸å…³èµ„æº<a target="_blank" href="/starcoin-cookbook/zh/assets/files/accumulator-98edda2c59e2a0b51e6167b0cc15e854.drawio">draw.io</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/starcoinorg/starcoin-cookbook/edit/main/docs/99-concepts/06-accumulator.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æ­¤é¡µ</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="æ–‡æ¡£åˆ†é¡µå¯¼èˆª"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/starcoin-cookbook/zh/docs/concepts/smt"><div class="pagination-nav__sublabel">ä¸Šä¸€é¡µ</div><div class="pagination-nav__label">Sparse Merkle Tree</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/starcoin-cookbook/zh/docs/concepts/proof"><div class="pagination-nav__sublabel">ä¸‹ä¸€é¡µ</div><div class="pagination-nav__label">Proof</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ç”¨é€”" class="table-of-contents__link toc-highlight">ç”¨é€”</a></li><li><a href="#èŠ‚ç‚¹ç±»å‹ä»‹ç»" class="table-of-contents__link toc-highlight">èŠ‚ç‚¹ç±»å‹ä»‹ç»</a></li><li><a href="#èŠ‚ç‚¹çš„frozen" class="table-of-contents__link toc-highlight">èŠ‚ç‚¹çš„Frozen</a></li><li><a href="#leaf-index-å’Œ-node-index" class="table-of-contents__link toc-highlight">Leaf Index å’Œ Node Index</a></li><li><a href="#accumulator-append-è¿‡ç¨‹" class="table-of-contents__link toc-highlight">Accumulator append è¿‡ç¨‹</a><ul><li><a href="#æ–°èŠ‚ç‚¹æ·»åŠ " class="table-of-contents__link toc-highlight">æ–°èŠ‚ç‚¹æ·»åŠ </a></li><li><a href="#æ ¹èŠ‚ç‚¹çš„è®¡ç®—" class="table-of-contents__link toc-highlight">æ ¹èŠ‚ç‚¹çš„è®¡ç®—</a></li></ul></li><li><a href="#accumulator-flush-å’Œ-accumulator-åœ¨-kvstore-ä¸­çš„å­˜å‚¨" class="table-of-contents__link toc-highlight">Accumulator flush å’Œ Accumulator åœ¨ KvStore ä¸­çš„å­˜å‚¨</a></li><li><a href="#æŸ¥è¯¢æ“ä½œ" class="table-of-contents__link toc-highlight">æŸ¥è¯¢æ“ä½œ</a></li><li><a href="#accumulator-çš„å¹‚ç­‰æ€§" class="table-of-contents__link toc-highlight">Accumulator çš„å¹‚ç­‰æ€§</a></li><li><a href="#accumulator-ä¸­apiè¯´æ˜" class="table-of-contents__link toc-highlight">Accumulator ä¸­APIè¯´æ˜</a><ul><li><a href="#åˆ›å»º-accumulator" class="table-of-contents__link toc-highlight">åˆ›å»º Accumulator</a></li><li><a href="#æ·»åŠ æ–°çš„å…ƒç´ " class="table-of-contents__link toc-highlight">æ·»åŠ æ–°çš„å…ƒç´ </a></li><li><a href="#ä¿å­˜æ ‘åˆ°-kvstore" class="table-of-contents__link toc-highlight">ä¿å­˜æ ‘åˆ° KvStore</a></li><li><a href="#è·å–å¶å­èŠ‚ç‚¹" class="table-of-contents__link toc-highlight">è·å–å¶å­èŠ‚ç‚¹</a></li><li><a href="#è·å–proof" class="table-of-contents__link toc-highlight">è·å–proof</a></li></ul></li><li><a href="#å…¶ä»–çç¢ç»†èŠ‚" class="table-of-contents__link toc-highlight">å…¶ä»–çç¢ç»†èŠ‚</a><ul><li><a href="#append-è¿‡ç¨‹ä¸­çš„è·å–-frozen_subtree_roots" class="table-of-contents__link toc-highlight">append è¿‡ç¨‹ä¸­çš„è·å– frozen_subtree_roots</a></li><li><a href="#nodeindex-ç›¸å…³æ“ä½œ" class="table-of-contents__link toc-highlight">NodeIndex ç›¸å…³æ“ä½œ</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/starcoin-cookbook/zh/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discor.gg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://t.me/starcoin_contributor" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Developer Telegram group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/StarcoinSTC" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Starcoin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/starcoin-cookbook/zh/assets/js/runtime~main.46521177.js"></script>
<script src="/starcoin-cookbook/zh/assets/js/main.da5c0ce0.js"></script>
</body>
</html>