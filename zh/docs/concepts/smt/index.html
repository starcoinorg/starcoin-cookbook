<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-concepts/smt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.22">
<title data-rh="true">Sparse Merkle Tree | Starcoin Cookbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/smt"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Sparse Merkle Tree | Starcoin Cookbook"><meta data-rh="true" name="description" content="要了解为什么用Sparse Merkle Tree (下面简称 SMT )，先需要了解下 Merkle Tree"><meta data-rh="true" property="og:description" content="要了解为什么用Sparse Merkle Tree (下面简称 SMT )，先需要了解下 Merkle Tree"><link data-rh="true" rel="icon" href="/starcoin-cookbook/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/smt"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/concepts/smt" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/zh/docs/concepts/smt" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/starcoin-cookbook/docs/concepts/smt" hreflang="x-default"><link rel="stylesheet" href="/starcoin-cookbook/zh/assets/css/styles.9755040e.css">
<link rel="preload" href="/starcoin-cookbook/zh/assets/js/runtime~main.65243483.js" as="script">
<link rel="preload" href="/starcoin-cookbook/zh/assets/js/main.def3f760.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/starcoin-cookbook/zh/"><div class="navbar__logo"><img src="/starcoin-cookbook/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_ToTc themedImage--light_HNdA"><img src="/starcoin-cookbook/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Starcoin Cookbook</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/starcoin-cookbook/zh/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/starcoin-cookbook/docs/concepts/smt" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/starcoin-cookbook/zh/docs/concepts/smt" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li></ul></div><a href="https://github.com/starcoinorg/starcoin-cookbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/starcoin-cookbook/zh/docs/intro">Starcoin CookBook 介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/starcoin-cookbook/zh/docs/getting-started/install/">新手入门</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/starcoin-cookbook/zh/docs/move/">Move 和智能合约开发</a><button aria-label="打开/收起侧边栏菜单「Move 和智能合约开发」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/starcoin-cookbook/zh/docs/web3/">Web3 和 DApp 开发</a><button aria-label="打开/收起侧边栏菜单「Web3 和 DApp 开发」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/starcoin-cookbook/zh/docs/reference/">参考</a><button aria-label="打开/收起侧边栏菜单「参考」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/starcoin-cookbook/zh/docs/concepts/merkletree">概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/merkletree">Merkle Tree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/account">账号</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/transaction">交易</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/block">区块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/state">状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/smt">Sparse Merkle Tree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/accumulator">Accumulator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/proof">Proof</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/starcoin-cookbook/zh/docs/concepts/multisig">多重签名</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/starcoin-cookbook/zh/docs/miscellaneous/contributing">杂项</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/starcoin-cookbook/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">概念</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Sparse Merkle Tree</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Sparse Merkle Tree</h1><p>要了解为什么用Sparse Merkle Tree (下面简称 SMT )，先需要了解下 <a href="/starcoin-cookbook/zh/docs/concepts/merkletree">Merkle Tree</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="smt">SMT<a class="hash-link" href="#smt" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="介绍下为啥需要用smt">介绍下为啥需要用SMT<a class="hash-link" href="#介绍下为啥需要用smt" title="标题的直接链接">​</a></h3><p>Starcoin 是基于账户模型，不同于以太坊个人账户和合约账户是分开的， Starcoin 中合约相关信息也都存储在 State 中。
State 包括合约代码( CODE )和资源( RESOURCE )，余额相关信息都在RESOURCE中，需要数据结构来处理账户地址到状态的映射，
也就是 AccountAddree -&gt; State， 直观上来这个映射就是 Key -&gt; Value 之间映射。
处理这个可以使用 HashMap，系统中维护一个全局的 HashMap，每次有新的账户创建就插入一对 Key， Value，
查询账户余额就在 HashMap 中使用 Key 来查询，
不考虑 Hash 碰撞，查询基本是常数时间完成(O(1))，更新也是，
这种设计最大问题是不能提供 Merkle Proof， 比如证明某个时间点这个账户余额大于多少( StateProof )。
一种想法是基于当时的 HashMap 构建 Merkle Tree，
基于这种想法，每次有新的区块发布的需要基于 HashMap 构建新的 Merkle Tree，
并将 Merkle Tree 对应的 Root_Hash 发布到 BlockHeader 中，
这个方案是有问题的，HashMap 效率很高，但是每次构建 Merkle Tree 效率很低。
还有一种想法是我们不用 HashMap，直接构建 Merkle Tree 把所有账户的状态都存下来，
这个方法的问题在于 Merkle Tree 没有提供高效查找和修改的方法。
这里使用了一种基于压缩 Trie 数据结构 Jellyfish-Merkle-Tree (JMT)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="smt设计原理">SMT设计原理<a class="hash-link" href="#smt设计原理" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="merkle-tree-到smt">Merkle Tree 到SMT<a class="hash-link" href="#merkle-tree-到smt" title="标题的直接链接">​</a></h4><p>在 Starcoin 中 Hash 的计算都是基于 sha3_256 ( Hash Struct 会加入 prefix 文末会给出示例代码) 计算来的， 所以这颗树是2的256次方个元素
下图显示了 Merkle Tree到 SMT的两个优化
<img loading="lazy" alt="three_smt" src="/starcoin-cookbook/zh/assets/images/three_smt-156d8e827819ceeb2c0f5f9fce42b5b6.png" width="1960" height="772" class="img_ev3q">
图1是一个 Merkle Tree，图2优化将空子树用 PlaceHolder (方格)代替， 节省了空间，
图3优化将只含有一个叶子节点的子树设置成节点， 这样减少了 Proof 时对 Hash 的计算。
这里 A 的2进制路径表示为0100， B 的为1000， C 的为1011</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="基数树前缀压缩">基数树前缀压缩<a class="hash-link" href="#基数树前缀压缩" title="标题的直接链接">​</a></h4><p>下图显示了基于压缩的优化
<img loading="lazy" alt="radix_tree" src="/starcoin-cookbook/zh/assets/images/radix_tree-e8b7c31253e86eb783c38ab42077fcbc.png" width="2852" height="938" class="img_ev3q">
这里图中的 Merkle Tree 的Key的长度都是8个bit，有很多空节点，很稀疏，可以进行压缩优化。
A 的2进制路径为00010100，每4个 bit 压缩后变成0x14，
B 的2进制路径为00011010，压缩后为0x1A，
C 的2进制路径为00011111，压缩后为0x1F，
D 的2进制路径为11101100，压缩后为0xDC，
这里每4个 bit 压缩叫做一个 Nibble，
Merkle Tree 可以认为是基数等于2的基数树，图中右边可以认为是基数等于16的基数树，
SMT 就是基于基数16的基数树(这里简称为 Radix16)，这个设计的优点就是降低树的高度，减少内存访问次数，降低内存，
这种 Radix Tree 目前有些优化手段比如 ADAPTIVE RADIX TREE (Starcoin中固定为 node16)， 论文(<a href="https://db.in.tum.de/~leis/papers/ART.pdf" target="_blank" rel="noopener noreferrer">https://db.in.tum.de/~leis/papers/ART.pdf</a>) 有更多内容，
还有其他一些 Radix Tree 优化思路，比如以太坊使用的是改进版本的 Patricia Radix Tree (<a href="https://eth.wiki/fundamentals/patricia-tree)%EF%BC%8C" target="_blank" rel="noopener noreferrer">https://eth.wiki/fundamentals/patricia-tree)，</a>
还有 HAT RADIX TREE， 这些这里不介绍</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="smt-数据结构和操作">SMT 数据结构和操作<a class="hash-link" href="#smt-数据结构和操作" title="标题的直接链接">​</a></h3><p>上面提到SMT实际上是一个Radix16 Trie， 在 Starcoin 中每个 SMT 中 Key 的长度是256 bit，这里基于4个 bit (一个 Nibble )做了压缩,对于任意一个输入，我们计算sha3_256后进行处理，
这样整个树的高度就变为64。
SMT 的节点类型分为 Null， InternalNode， LeafNode，
Null 就是前面提到的 PlaceHolder(方格)， InternalNode 最多有16个子节点( InternalNode 对应一个 HashMap， 子节点索引为为0-16，子节点类型是 InternalNode 或者 LeafNode )， LeafNode 存储的是实际的 Key， Value 的键值对。
区块链中需要保存历史状态，这里如何查询某个 Key 的历史状态，之前提到 Merkle Tree 里保存 Root_Hash 就认为是保存了整棵树，
需要提供树的根节点值( Root_Hash )和查询的 Key ，这个根节点就是在 Starcoin 中 BlockHeader 中的 state_root ， 这也是后续讲到 StateTree 的构建需要用到 state_root。
Starcoin 中 SMT 需要持久化到 KvStore ， 这里用的是 RocksDB (测试中 MockTreeStore 使用的是 HashMap + BTreeSet)，
为了将整个 SMT 保存在 KvStore 中，SMT 的所有节点都只存储 Hash 值(对应的内容通过 KvStore 保存和查询)，存储时需要将 Null， InternalNode， LeafNode 节点序列化存储在 KvStore 中。
例如查找 Key 为 Hello 对应的 Value， 在 SMT 中计算 <code>Key_Hash = sha3_256(&quot;Hello&quot;)</code>， 操作都是对 Key_Hash 进行。</p><p>这里说明下 SMT 中各种节点</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub struct Child {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // The hash value of this child node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub hash: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Whether the child is a leaf node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub is_leaf: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub type Children = HashMap&lt;Nibble, Child&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct InternalNode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Up to 16 Children.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Children: Children,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Node&#x27;s hash cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cached_hash: Cell&lt;Option&lt;HashValue&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub trait RawKey: Clone + Ord {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Raw key&#x27;s hash, will used as tree&#x27;s nibble path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Directly use origin byte&#x27;s sha3_256 hash, do not use CryptoHash to add salt.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn key_hash(&amp;self) -&gt; HashValue {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HashValue::sha3_256_of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.encode_key()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .expect(&quot;Serialize key failed when hash.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .as_slice(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Encode the raw key, the raw key&#x27;s bytes will store to leaf node.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn encode_key(&amp;self) -&gt; Result&lt;Vec&lt;u8&gt;&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn decode_key(bytes: &amp;[u8]) -&gt; Result&lt;Self&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct LeafNode&lt;K: RawKey&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The origin key associated with this leaf node&#x27;s Blob.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #[serde(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deserialize_with = &quot;deserialize_raw_key&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serialize_with = &quot;serialize_raw_key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raw_key: K,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The hash of the blob.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blob_hash: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The blob associated with `raw_key`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blob: Blob,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #[serde(skip)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cached_hash: Cell&lt;Option&lt;HashValue&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Child 的定义可以看到只存储了 Hash 值，Value 通过 <code>KvStore.get(Hash)</code>  获取， 然后再反序列化确定是 InternalNode 还是 LeafNode。</p><p>下面说明下各个操作流程</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在空树种创建-leafnode-例子">在空树种创建 LeafNode 例子<a class="hash-link" href="#在空树种创建-leafnode-例子" title="标题的直接链接">​</a></h2><p>我们在一颗空树种插入 Key &quot;Hello&quot;， Value &quot;World&quot;，
基于这个产生一个叶子节点和叶子节点的 Hash 值，这个 Hash 值就是 SMT 新的根节点，
Hash 值和 LeafNode 序列化后插入到 KvStore 中。图中说明了这点</p><p><img loading="lazy" alt="empty_tree_insert" src="/starcoin-cookbook/zh/assets/images/empty_tree_insert-cd6d861b3a69ce5edaee505601b4ddef.png" width="226" height="201" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="插入流程">插入流程<a class="hash-link" href="#插入流程" title="标题的直接链接">​</a></h2><p>在 Starcoin 中 Hash 值是256 bit， 画图不方便，这里用短点地址16 bit做例子</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="空树插入叶子">空树插入叶子<a class="hash-link" href="#空树插入叶子" title="标题的直接链接">​</a></h3><p>开始为空 SMT,插入一个 Key1， Value1， 生成的 LeafNode1 的 Hash1 为0x1234，
这个是新的根节点， 如下图</p><p><img loading="lazy" alt="one_leaf" src="/starcoin-cookbook/zh/assets/images/one_leaf-5047dff6ef89d06adde65dfb161c3ae2.png" width="281" height="176" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新插入叶子节点和某个叶子节点有公共前缀">新插入叶子节点和某个叶子节点有公共前缀<a class="hash-link" href="#新插入叶子节点和某个叶子节点有公共前缀" title="标题的直接链接">​</a></h3><p>在上面基础下新插入 Key2， Value2， 需要查找 Key2 插入的位置， 先计算 Key2 的 <code>Key2_Hash = Hash(Key2)</code>，
假设 Key2_Hash 值为0x1236，  Key2_Hash 和 Root_Hash1 有公共前缀0x123， 先由 Key2， Value2 生成一个 LeafNode2，
由于 LeafNode1 的 Hash 值和 Key2_Hash 有公共前缀0x123，需要生成一个 InternalNode,记为 Children1，其中 <code>Children1[4] = Hash(LeafNode1)， Children1[6] = Hash(LeafNode2)</code>。
公共前缀0x12， 0x1也需要生成 InternalNode。这里先构造0x12的 InternalNode 记为 Children2， <code>Children2[3] = Hash(Children1)</code>，
然后构造0x1的 InternalNode 记为 Children3， <code>Children3[2]= Hash(Children2)</code>。
LeafNode2，Children1，Children2， Children3 按照 Hash 和序列化后的键值对写入到 KvStore，
新生成的根节点是 Hash(Children3)。</p><p><img loading="lazy" alt="two_leaf_insert" src="/starcoin-cookbook/zh/assets/images/two_leaf_insert-fd529a2513fe1e764ad0e6b1bfd58865.png" width="572" height="296" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新插入叶子结点和某个内部节点有公共前缀">新插入叶子结点和某个内部节点有公共前缀<a class="hash-link" href="#新插入叶子结点和某个内部节点有公共前缀" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="内部节点插入新子节点">内部节点插入新子节点<a class="hash-link" href="#内部节点插入新子节点" title="标题的直接链接">​</a></h4><p>在上面基础上，假定插入 Key3，Value3，
假定插入 Key3 的 Hash 值 Key3_Hash 为0x35ef， Children3 的索引3的子节点为空， 将 Key3， Value3 生成新的叶子节点 LeafNode3，
<code>Children3[3] = Hash(LeafNode3)</code>。
将 LeafNode3，Children3 按照 Hash 和序列化后键值对写入到 KvStore， 新生成的根节点是 Hash(Children3)。
如下面这图</p><p><img loading="lazy" alt="internal_insert_leaf" src="/starcoin-cookbook/zh/assets/images/internal_insert_leaf-58bfccb771a77f8377cf667a81825563.png" width="751" height="324" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="内部节点更新子节点">内部节点更新子节点<a class="hash-link" href="#内部节点更新子节点" title="标题的直接链接">​</a></h4><p>假定插入 Key3_Hash 值为0x25ef，Children3 的索引2的子节点为 Children2，递归处理在 Children2 插入，
更新 Children2， 更新<code>Children3[2] = Hash(Children2)</code>，
将 Children2， Children3 按照 Hash 和序列化值写入到 KvStore，新生成的根节点是 Hash(Children3)。
如下面这图，这种情况对应当前 InternalNode 修改已存在的子节点，需要递归处理
<img loading="lazy" alt="internal_insert_recursive" src="/starcoin-cookbook/zh/assets/images/internal_insert_recursive-17ab6a7faccd024b1214d9d6866d96ce.png" width="791" height="326" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="查询流程">查询流程<a class="hash-link" href="#查询流程" title="标题的直接链接">​</a></h2><p>在上面流程基础上，假设要查询的 Key4，先计算 Key4 的 <code>Key4_Hash = Hash(key4)</code>， 在 Starcoin 中 Key4_Hash 是个256 bit 的值，也就是64个 Nibble (一个 Nibble 为4bit)， 记为<code>Nibble0..Nibble63</code>。
查找先从根节点 Root_Hash 获取根节点对应 Node ，查看 Node 是 LeafNode 还是 InternalNode，
<!-- -->[1]<!-- -->如果是 LeafNode，查看下 LeafNode 对应的 Key 的 Hash 值是否和 Key4_Hash 相等，相等就返回结果， 不相等返回 None
<!-- -->[2]<!-- -->如果是 IntenalNode 查找 InternalNode 对应 Nibblei 的子节点(初始<code>i = 0</code>，每次<code>i = i + 1</code>)，查找到新 Node 是 LeafNode，走条件<!-- -->[1]<!-- -->， 否则跳转到<!-- -->[2]<!-- -->
流程图在下面图中，代码在 Starcoin 中对应 get_proof_with</p><p><img loading="lazy" alt="search" src="/starcoin-cookbook/zh/assets/images/search-92ac19f6a8beb75ed1bc687085699f92.png" width="653" height="491" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="smt-api-相关说明">SMT API 相关说明<a class="hash-link" href="#smt-api-相关说明" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new">new<a class="hash-link" href="#new" title="标题的直接链接">​</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn new(TreeReader: &amp;&#x27;a) -&gt; Self {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 TreeReader 是一个 trait (可以认为是类似 Java 中 inteface )， 在 Starcoin 中是提供 Key Value 操作的数据结构，
在 Starcoin 中对应的 KvStore 是 RocksDB， MockTreeStore 中使是 HashMap + BTeeSet，
有 TreeReader 就有 TreeWriter，这里 TreeReader 对应的是 SMT 的查找和在内存中的计算， TreeWriter 对应的是持久化到 KvStore 操作，
Starcoin 持久层并没有实现 TreeWriter trait，现在直接写 KvStore(这部分需要结合 代码中StateDB 的 flush 来理解)， Mock 操作的 MockTreeStore 使用了 TreeWriter。
可以简单认为 SMT 是内存中一颗 Trie 树，持久化在 RocksDB 上。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="updates">updates<a class="hash-link" href="#updates" title="标题的直接链接">​</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn updates(&amp;self,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state_root_hash: Option&lt;HashValue&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    blob_set: Vec&lt;(KEY, Vec&lt;u8&gt;)&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) -&gt; Result&lt;(HashValue, TreeUpdateBatch&lt;KEY&gt;)&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct StaleNodeIndex {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub stale_since_version: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub node_key: HashValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct TreeUpdateBatch&lt;KEY&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub node_batch: BTreeMap&lt;HashValue, Node&lt;KEY&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub stale_node_index_batch: BTreeSet&lt;StaleNodeIndex&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub num_new_leaves: usize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub num_stale_leaves: usize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里 HashValue 就是之前提到的 sha3_256 的计算值，
这里说明下各个参数，
state_root_hash 是某个 SMT 树的根节点 Hash 值，通过 Hash 值唯一确定了这颗 SMT，
blob_set 是 Key，Value 列表，
这么设计是为了一个 Block 执行交易后满足幂等性 这里 state_root_hash 等于前一个 BlockHeader 中的 state_root ( SMT 的 Root_Hash 值)，
返回值<code>Result&lt;(HashValue, TreeUpdateBatch&lt;KEY&gt;)&gt;</code> HashValue 代表新的 SMT 的 Hash 值， 这个新的 HashValue 存储在 BlockHeader 中的 state_root，
返回值中 TreeUpdateBatch 里面的 node_batch， 这里比如我们 blob_set 是<code>[(Key1, Value1), (Key2, Value2]</code>，
SMT 会产生 LeafNode 和 InternalNode，会把这些按照Hash值和自身存到 BTreeMap 中，
StaleNodeIndex 中 stale_since_version 是这次新产生的根节点 Hash， node_key 是被修改过的 Node 的 Hash。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="get_proof_with">get_proof_with<a class="hash-link" href="#get_proof_with" title="标题的直接链接">​</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn get_with_proof(&amp;self, key: &amp;K) -&gt; Result&lt;(Option&lt;Vec&lt;u8&gt;&gt;, SparseMerkleProof)&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>获取 Key 对应的 Value 的值，如果存在并返回对应的 Merkle Proof 证明。
<a href="/starcoin-cookbook/zh/docs/concepts/proof">proof</a> 待补充。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="starcoin-中-sha3_256--struct-示例代码">Starcoin 中 sha3_256  Struct 示例代码<a class="hash-link" href="#starcoin-中-sha3_256--struct-示例代码" title="标题的直接链接">​</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let buf = hex::decode(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;0xfa000000000000007b161ceeef010000000000000000000000000000000000000000000000000000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.strip_prefix(&quot;0x&quot;).unwrap()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">).unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let blob = Blob::from(buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let salt_prefix: &amp;[u8] = b&quot;STARCOIN::Blob&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let ser = bcs::to_bytes(&amp;blob)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let salt = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HashValue::sha3_256_of(salt_prefix).as_slice(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ser.as_slice(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.concat();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let hash = HashValue::sha3_256_of(&amp;salt[..]);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考文档">参考文档<a class="hash-link" href="#参考文档" title="标题的直接链接">​</a></h3><p><a href="https://developers.diem.com/papers/jellyfish-merkle-tree/2021-01-14.pdf" target="_blank" rel="noopener noreferrer">https://developers.diem.com/papers/jellyfish-merkle-tree/2021-01-14.pdf</a></p><p><a href="https://westar.io/blog/jellyfish-merkle-tree-in-libra/" target="_blank" rel="noopener noreferrer">https://westar.io/blog/jellyfish-merkle-tree-in-libra/</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="相关资源">相关资源<a class="hash-link" href="#相关资源" title="标题的直接链接">​</a></h3><p><a target="_blank" href="/starcoin-cookbook/zh/assets/files/smt-d0a8b2f5d64d43cbcdeaf186252002f6.drawio">draw.io</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/starcoinorg/starcoin-cookbook/edit/main/i18n/zh/docusaurus-plugin-content-docs/current/99-concepts/05-smt.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/starcoin-cookbook/zh/docs/concepts/state"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">状态</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/starcoin-cookbook/zh/docs/concepts/accumulator"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Accumulator</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#smt" class="table-of-contents__link toc-highlight">SMT</a><ul><li><a href="#介绍下为啥需要用smt" class="table-of-contents__link toc-highlight">介绍下为啥需要用SMT</a></li><li><a href="#smt设计原理" class="table-of-contents__link toc-highlight">SMT设计原理</a></li><li><a href="#smt-数据结构和操作" class="table-of-contents__link toc-highlight">SMT 数据结构和操作</a></li></ul></li><li><a href="#在空树种创建-leafnode-例子" class="table-of-contents__link toc-highlight">在空树种创建 LeafNode 例子</a></li><li><a href="#插入流程" class="table-of-contents__link toc-highlight">插入流程</a><ul><li><a href="#空树插入叶子" class="table-of-contents__link toc-highlight">空树插入叶子</a></li><li><a href="#新插入叶子节点和某个叶子节点有公共前缀" class="table-of-contents__link toc-highlight">新插入叶子节点和某个叶子节点有公共前缀</a></li><li><a href="#新插入叶子结点和某个内部节点有公共前缀" class="table-of-contents__link toc-highlight">新插入叶子结点和某个内部节点有公共前缀</a></li></ul></li><li><a href="#查询流程" class="table-of-contents__link toc-highlight">查询流程</a></li><li><a href="#smt-api-相关说明" class="table-of-contents__link toc-highlight">SMT API 相关说明</a><ul><li><a href="#new" class="table-of-contents__link toc-highlight">new</a></li><li><a href="#updates" class="table-of-contents__link toc-highlight">updates</a></li><li><a href="#get_proof_with" class="table-of-contents__link toc-highlight">get_proof_with</a></li><li><a href="#starcoin-中-sha3_256--struct-示例代码" class="table-of-contents__link toc-highlight">Starcoin 中 sha3_256  Struct 示例代码</a></li><li><a href="#参考文档" class="table-of-contents__link toc-highlight">参考文档</a></li><li><a href="#相关资源" class="table-of-contents__link toc-highlight">相关资源</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/starcoin-cookbook/zh/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discor.gg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/starcoin_contributor" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Telegram group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/StarcoinSTC" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Starcoin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/starcoin-cookbook/zh/assets/js/runtime~main.65243483.js"></script>
<script src="/starcoin-cookbook/zh/assets/js/main.def3f760.js"></script>
</body>
</html>