<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-move/move-prover/mvp-tutorial">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.22">
<title data-rh="true">验证智能合约：Move Prover 教程 | Starcoin Cookbook</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://starcoinorg.github.io/zh/docs/move/move-prover/mvp-tutorial"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="验证智能合约：Move Prover 教程 | Starcoin Cookbook"><meta data-rh="true" name="description" content="什么是 Move Prover"><meta data-rh="true" property="og:description" content="什么是 Move Prover"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://starcoinorg.github.io/zh/docs/move/move-prover/mvp-tutorial"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/docs/move/move-prover/mvp-tutorial" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/zh/docs/move/move-prover/mvp-tutorial" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://starcoinorg.github.io/docs/move/move-prover/mvp-tutorial" hreflang="x-default"><link rel="stylesheet" href="/zh/assets/css/styles.bd80adfe.css">
<link rel="preload" href="/zh/assets/js/runtime~main.dce544f6.js" as="script">
<link rel="preload" href="/zh/assets/js/main.4328e06e.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zh/img/logo.svg" alt="Starcoin Cookbook" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Starcoin Cookbook</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/docs/move/move-prover/mvp-tutorial" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh/docs/move/move-prover/mvp-tutorial" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文</a></li></ul></div><a href="https://github.com/starcoinorg/starcoin-cookbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh/docs/intro">Starcoin CookBook 介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/getting-started/install/">新手入门</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/zh/docs/move/">Move 和智能合约开发</a><button aria-label="打开/收起侧边栏菜单「Move 和智能合约开发」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/prepare-move-env">设置 Move 开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/quick-start">快速开始</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/move-language/">Move 语言</a><button aria-label="打开/收起侧边栏菜单「Move 语言」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/understanding-ability">认识 Ability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/move-package-manager">Move 包管理器用户指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/starcoin-framework/">Starcoin Move Framework</a><button aria-label="打开/收起侧边栏菜单「Starcoin Move Framework」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/deploy-first-move-contract">如何部署 Move 智能合约</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/interacting-with-the-contract">与合约交互</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/module-dependency">Understanding module dependency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/how-to-upgrade">How to upgrade Move Module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/for-solidity-developer">For solidity developer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/call-function">如何调用函数</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/move-vm/">Move VM 原理分析</a><button aria-label="打开/收起侧边栏菜单「Move VM 原理分析」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/move-test/">如何测试 Move Module</a><button aria-label="打开/收起侧边栏菜单「如何测试 Move Module」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/move-examples/">更多 Move 例子</a><button aria-label="打开/收起侧边栏菜单「更多 Move 例子」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/zh/docs/move/advance-move/">Move 高级开发</a><button aria-label="打开/收起侧边栏菜单「Move 高级开发」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/zh/docs/move/move-prover/">Move 规范语言和 Move Prover</a><button aria-label="打开/收起侧边栏菜单「Move 规范语言和 Move Prover」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/move/move-prover/move-spec-language">Move 规范语言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh/docs/move/move-prover/mvp-tutorial">验证智能合约：Move Prover 教程</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/web3/">Web3 和 DApp 开发</a><button aria-label="打开/收起侧边栏菜单「Web3 和 DApp 开发」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/reference/">参考</a><button aria-label="打开/收起侧边栏菜单「参考」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/concepts/">概念</a><button aria-label="打开/收起侧边栏菜单「概念」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/miscellaneous/contributing">杂项</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/zh/docs/move/"><span itemprop="name">Move 和智能合约开发</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/zh/docs/move/move-prover/"><span itemprop="name">Move 规范语言和 Move Prover</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">验证智能合约：Move Prover 教程</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>验证智能合约：Move Prover 教程</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-move-prover">什么是 Move Prover<a class="hash-link" href="#什么是-move-prover" title="标题的直接链接">​</a></h2><p>形式化验证是一种使用严格的数学方法来描述行为和推理计算机系统的正确性的技术。现在已经在操作系统、编译器等对正确性要求高的领域有一定应用。</p><p>部署在区块链上的智能合约操纵着各种数字资产，它们的正确性也十分关键。<strong>Move Prover（MVP）</strong> 就是为防止 Move 语言编写的智能合约中的错误而设计。
用户可以使用 <strong>Move 规范语言（MSL）</strong> 指定智能合约的功能属性，然后使用 Move Prover 自动静态地检查它们。</p><p>简单地说，Move 文件中可以有两种成分：</p><ul><li>一部分是程序代码，这是我们多数人最熟悉的部分。它用 Move 程序语言 (有时候也直接叫 Move 语言) 写成。我们用它定义数据类型、函数。</li><li>另一部分是形式规范（Formal specification）。它是可选的，用 Move 规范语言写成。我们用它说明程序代码应该满足怎样的性质。比如描述函数的行为。</li></ul><p>当我们写了形式规范的时候，调用 Move Prover 后，它会按照写的规范去验证 Move 程序有没有满足这些要求，帮助开发人员在开发阶段尽早发现潜在的问题，
并让其它用户对已经验证过的程序性质有信心。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="安装-prover-的依赖">安装 Prover 的依赖<a class="hash-link" href="#安装-prover-的依赖" title="标题的直接链接">​</a></h2><p>在使用 Move Prover 前，我们先安装它的一些外部依赖。
假设你已经有了一份 <a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer">Starcoin</a> 的源代码，并且已经构建了项目。
我们切换到 Starcoin 的根目录下，运行下面的命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$PATH_TO_STARCOIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/dev_setup.sh -ypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> ~/.profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当上面的命令执行完毕时，输入 <code>boogie /version</code>，如果输出类似 &quot;Boogie program verifier version X.X.X&quot;，那么安装已经成功。</p><p>注意，目前 Move Prover 只能在 UNIX 系操作系统下运行（例如 Linux、macOS）。
Windows 用户可以通过安装 <a href="https://docs.microsoft.com/en-us/windows/wsl/install" target="_blank" rel="noopener noreferrer">WSL</a> 来运行。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备要验证的示例">准备要验证的示例<a class="hash-link" href="#准备要验证的示例" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="项目创建">项目创建<a class="hash-link" href="#项目创建" title="标题的直接链接">​</a></h3><p>首先，我们来创建一个新的空 Move 包：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mpm package new BasicCoin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到它的目录结构如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BasicCoin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |---- Move.toml (text file)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `---- sources   (Directory)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="模块代码">模块代码<a class="hash-link" href="#模块代码" title="标题的直接链接">​</a></h3><p>现在创建 <code>BasicCoin/sources/BasicCoin.move</code>。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> BasicCoin.move 内容</summary><div><div class="collapsibleContent_i85q"><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// This module defines a minimal and generic Coin and Balance.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module NamedAddr::BasicCoin {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use StarcoinFramework::Errors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use StarcoinFramework::Signer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Error codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const ENOT_MODULE_OWNER: u64 = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const EINSUFFICIENT_BALANCE: u64 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const EALREADY_HAS_BALANCE: u64 = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct Coin&lt;phantom CoinType&gt; has store {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: u64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct Balance&lt;phantom CoinType&gt; has key {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        coin: Coin&lt;CoinType&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Publish an empty balance resource under `account`&#x27;s address. This function must be called before</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// minting or transferring to the account.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun publish_balance&lt;CoinType&gt;(account: &amp;signer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let empty_coin = Coin&lt;CoinType&gt; { value: 0 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert!(!exists&lt;Balance&lt;CoinType&gt;&gt;(Signer::address_of(account)), Errors::already_published(EALREADY_HAS_BALANCE));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        move_to(account, Balance&lt;CoinType&gt; { coin:  empty_coin });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Mint `amount` tokens to `mint_addr`. This method requires a witness with `CoinType` so that the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// module that owns `CoinType` can decide the minting policy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun mint&lt;CoinType: drop&gt;(mint_addr: address, amount: u64, _witness: CoinType) acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Deposit `total_value` amount of tokens to mint_addr&#x27;s balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deposit(mint_addr, Coin&lt;CoinType&gt; { value: amount });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun balance_of&lt;CoinType&gt;(owner: address): u64 acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        borrow_global&lt;Balance&lt;CoinType&gt;&gt;(owner).coin.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Transfers `amount` of tokens from `from` to `to`. This method requires a witness with `CoinType` so that the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// module that owns `CoinType` can  decide the transferring policy.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public fun transfer&lt;CoinType: drop&gt;(from: &amp;signer, to: address, amount: u64, _witness: CoinType) acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let check = withdraw&lt;CoinType&gt;(addr_from, amount);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        deposit&lt;CoinType&gt;(to, check);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun withdraw&lt;CoinType&gt;(addr: address, amount: u64) : Coin&lt;CoinType&gt; acquires Balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance = balance_of&lt;CoinType&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert!(balance &gt;= amount, EINSUFFICIENT_BALANCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance_ref = &amp;mut borrow_global_mut&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *balance_ref = balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Coin&lt;CoinType&gt; { value: amount }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun deposit&lt;CoinType&gt;(addr: address, check: Coin&lt;CoinType&gt;) acquires Balance{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance = balance_of&lt;CoinType&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let balance_ref = &amp;mut borrow_global_mut&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let Coin { value } = check;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        *balance_ref = balance + value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>这里我们假设您已经对 Move 语言有一定掌握，并能理解上面 <code>BasicCoin.move</code> 的源码和知道各个部分的作用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="toml-配置">TOML 配置<a class="hash-link" href="#toml-配置" title="标题的直接链接">​</a></h3><p>BasicCoin 使用到了 Starcoin 标准库的一些设施，也要把 <code>StarcoinFramework</code> 添加到依赖当中。
同时，BasicCoin 中用到了命名地址，我们也要指定它应该被何数值地址替换。
因此，我们把 Move.toml 修改如下：</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[package]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name = &quot;BasicCoin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version = &quot;0.0.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[addresses]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NamedAddr = &quot;0xcafe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StarcoinFramework = { git = &quot;https://github.com/starcoinorg/starcoin-framework&quot;, rev=&quot;01c84198819310620f2417413c3c800df8292ae5&quot; }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="第一段验证代码">第一段验证代码<a class="hash-link" href="#第一段验证代码" title="标题的直接链接">​</a></h2><p>为了让我们对 Move Prover 的使用有一个初步印象，在 <code>BasicCoin.move</code> 中 添加以下代码片段：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>语法上，这段代码可以添加在 BasicCoin 这个模块内的任何地方，但为了让阅读代码的时候方便清晰地看到定义和规范的对应关系，推荐把它就放在 <code>balance_of</code> 函数的定义后面。</p><p>简单地说，<code>spec balance_of {...}</code> 这个代码块将会包含我们对 <code>balance_of</code> 这个函数的<strong>性质规范 (property specification)</strong>。
性质规范有很多种，常见的一些例子有：</p><ul><li>这个函数会异常中止 (abort) 吗？它在什么情况下会异常中止？</li><li>调用这个函数的参数要满足什么条件？</li><li>这个函数的返回值是怎样的？</li><li>函数执行后，会对虚拟机状态产生怎样的改变？</li><li>这个函数会维持怎样的不变量（invariant）？</li></ul><p>例如，当我们没有给出任何中止条件时，Move Prover 默认允许一切可能的异常中止。
而上面这个简单的片段中，我们用指示 <code>aborts_if_is_strict</code> 告诉 Prover：</p><blockquote><p>我希望严格检查这个函数的异常中止的可能。如果出现了任何程序员没有列出的中止的情况，请报错。</p></blockquote><p>现在，我们在 <code>BasicCoin</code> 目录下运行 <code>prove</code> 命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mpm package prove</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>mpm 会调用 Move Prover 对包内的代码进行检查。然后我们可以看到 Prover 报下面这样的错误信息：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">error: abort not covered by any of the `aborts_if` clauses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ┌─ ./sources/BasicCoin.move:38:5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">35 │           borrow_global&lt;Balance&lt;CoinType&gt;&gt;(owner).coin.value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │           ------------- abort happened here with execution failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">38 │ ╭     spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">39 │ │       pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">40 │ │     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │ ╰─────^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:34: balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         owner = 0x29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:35: balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         ABORTED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: exiting with verification errors</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Prover 的输出告诉我们，它找到了一种让 <code>balance_of</code> 函数异常中止的情形，但我们却没有明确指出这种异常中止的可能。
接着看触发异常中止的代码，可以发现，异常是在 <code>owner</code> 不拥有 <code>Balance&lt;CoinType&gt;</code> 类型的资源时调用内置的 <code>borrow_global</code> 函数造成的。
根据错误信息的指导，我们便可以添加如下的 <code>aborts_if</code> 条件：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec balance_of {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pragma aborts_if_is_strict;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(owner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>添加这个条件后，尝试再调用 Prover，可以看到不再有验证错误。
现在我们可以有信心确认：<code>balance_of</code> 函数有且仅有一种异常结束的可能，那就是参数 <code>owner</code> 不拥有 <code>Balance&lt;CoinType&gt;</code> 类型的资源。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证-withdraw-函数">验证 <code>withdraw</code> 函数<a class="hash-link" href="#验证-withdraw-函数" title="标题的直接链接">​</a></h2><p>函数 <code>withdraw</code> 的签名如下:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fun withdraw&lt;CoinType&gt;(addr: address, amount: u64) : Coin&lt;CoinType&gt; acquires Balance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它的作用是从地址 <code>addr</code> 中取出金额为 <code>amount</code> 的币，并将其返回。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="指定-widthdraw-的中止条件">指定 <code>widthdraw</code> 的中止条件<a class="hash-link" href="#指定-widthdraw-的中止条件" title="标题的直接链接">​</a></h3><p><code>withdraw</code> 有两种异常中止的可能：</p><ol><li><code>addr</code> 中没有 <code>Balance&lt;CoinType&gt;</code> 类型的资源</li><li><code>addr</code> 中的余额小于 <code>amount</code></li></ol><p>根据这些，我们可以像这样定义中止条件：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到，</p><ul><li>一个 spec 块可以包含 let 绑定，它可以给比较长的表达式绑定一个名称，并可以反复使用。
<code>global&lt;T&gt;(addr): T</code> 是一个内置函数，它返回地址 <code>addr</code> 处类型为 <code>T</code> 的资源。
这里，我们通过 let 绑定将 <code>balance</code> 设置为 <code>addr</code> 所拥有的代币数量；</li><li><code>exists&lt;T&gt;(address): bool</code>是一个内置函数，如果资源 <code>T</code> 在地址 <code>addr</code> 处存在，则返回 true；否则返回 false.</li></ul><p>这两行 <code>aborts_if</code> 语句对应于上面提到的两个条件。
一般来说，如果某个函数有多个 <code>aborts_if</code> 条件，这些条件就会被或逻辑连接起来。</p><p>像前面提到的那样，如果我们没指定任何异常中止的条件，Prover 就不会对异常中止作任何限制。
但一旦我们给出了任何一种中止的条件，Prover 就默认我们想严格检查所有异常中止的可能，因此需要列出所有可能的条件，
相当于隐式加了 <code>pragma aborts_if_is_strict</code> 这条指示。
如果只列出了部分异常退出的条件，Prover 会报验证错误。
然而，如果在 spec 块中定义了 <code>pragma aborts_if_is_partial</code>, 就相当于告诉 Prover：</p><blockquote><p>我只想列出一部分会导致异常中止的条件，请仅仅验证在这些条件下是否会异常中止。</p></blockquote><p>如果感兴趣的话，可以做这样一组实验来验证：</p><ul><li>当删除上面两个 <code>aborts_if</code> 条件当中的<strong>任何一个</strong>时，Prover 将会报错；</li><li>当同时删除所有 <code>aborts_if</code> 条件时，Prover 反而不会报错；</li><li>当加上 <code>pragma aborts_if_is_partial</code> 时，无论保留几条 <code>aborts_if</code> 条件，Prover 都不会报错（当然了，条件本身要是正确的）。</li></ul><p>有读者可能会对 spec 块中三个语句的顺序的排列产生好奇：
<code>balance</code> 的定义为什么可以写在 <code>aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr)</code> 的后面。
因为，如果后者成立的话，<code>balance</code> 实际上是不存在的。这个顺序不会导致 Prover 出错吗？
简单地说：不会，spec 块当中的语句是声明式的，顺序没有任何影响。</p><p>如果想作更细致的了解，可以参考 <a href="#TODO">MSL 文档</a> 以获得更多信息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="指定-withdraw-的功能性质">指定 <code>withdraw</code> 的功能性质<a class="hash-link" href="#指定-withdraw-的功能性质" title="标题的直接链接">​</a></h3><p>接下来我们来定义功能性质。
下面 spec 块当中的两个 <code>ensures</code> 语句给出了我们对 <code>widthdraw</code> 功能上的期待：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures result == Coin&lt;CoinType&gt; { value: amount };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这段代码中，首先通过使用 <code>let post</code> 绑定，把 <code>balance_post</code> 定义为函数执行后 <code>addr</code> 的余额，它应该等于 <code>balance - amount</code>。
然后，<code>result</code> 是一个特殊的名字，表示返回值，它应该是金额为 <code>amount</code> 的代币。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证-deposit-函数">验证 <code>deposit</code> 函数<a class="hash-link" href="#验证-deposit-函数" title="标题的直接链接">​</a></h2><p>函数 <code>deposit</code> 的签名如下：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fun deposit&lt;CoinType&gt;(addr: address, check: Coin&lt;CoinType&gt;) acquires Balance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它将 <code>check</code> 表示的代币资金存入到地址 <code>addr</code> 当中。它的规范定义如下:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec deposit {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let check_value = check.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + check_value &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + check_value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里将 <code>balance</code> 定义为函数执行前 <code>addr</code> 中的余额，将 <code>check_value</code> 定义为要存入的代币金额。它在下面两种情况下会异常中断：</p><ol><li><code>addr</code> 中没有类型为 <code>Balance&lt;CoinType&gt;</code> 的资源；</li><li>或者 <code>balance</code> 和 <code>check_value</code> 之和大于 <code>u64</code> 类型的最大值。</li></ol><p><code>ensures</code> 语句用于让 Prover 确定在任何情况下，函数执行后 <code>addr</code> 中的余额都可以被正确地更新。</p><p>前面提到过的语法此处不再赘述。
敏锐的读者可能已经发现，有一点值得注意：表达式 <code>balance + check_value &gt; MAX_U64</code> 在 Move 程序中是有问题的。
因为左边的加法会可能引起溢出的异常。
如果我们在 Move 程序中想写一个类似的检查，应该用类似 <code>balance &gt; MAX_U64 - check_value</code> 的表达式来避开溢出的问题。</p><p>但是，这个表达式在 Move 规范语言（MSL）中却完全没问题。
由于 spec 块使用的是 MSL 语言，它的类型系统和 Move 不一样。
MSL 中，所有的整数都是 <code>num</code> 类型，它是数学意义上的整数。也就是说，它是有符号数，而且没有大小限制。
当在 MSL 中引用 Move 程序中的数据时，所有内置整数类型 （<code>u8</code>，<code>u64</code> 等）都会被自动转换成 <code>num</code> 类型。
在 MSL 文档中可以找到更详细的关于类型系统的说明。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证-transfer-函数">验证 <code>transfer</code> 函数<a class="hash-link" href="#验证-transfer-函数" title="标题的直接链接">​</a></h2><p>函数 <code>transfer</code> 的签名如下：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public fun transfer&lt;CoinType: drop&gt;(from: &amp;signer, to: address, amount: u64, _witness: CoinType) acquires Balance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它负责从账户 <code>from</code> 到地址 <code>to</code> 的转账，转账金额为 <code>amount</code>。</p><p>我们先暂时忽略异常中止条件，只考虑它的功能性质，来试试将其验证规范写出来：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_from = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_to = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_from_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_to_post = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_to_post == balance_to + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里的 <code>from</code> 是 <code>signer</code> 类型，而并非一个直接的地址。
虽然程序中我们有创建一个名为 <code>addr_from</code> 的局部变量，但在 spec 块中我们无法直接引用它。
同时，这个地址的表达式要重复好几次，反复书写很累赘，我们再次把它绑定到 <code>addr_from</code> 上面。
然后用 <code>let</code> 和 <code>let post</code> 定义几个变量，对应着函数执行前后 <code>addr_from</code> 和 <code>to</code> 两个地址内的余额。
最后用 <code>ensures</code> 语句告诉 Prover <code>from</code> 内的余额应该减去 <code>amount</code>；<code>to</code> 内的余额以应该增加 <code>amount</code>。</p><p>乍看之下，似乎完全没有问题。可是真的是这样吗？
我们来看看 Prover 是否认为这就是「对这个函数行为的正确描述」。
在输入 <code>mpm package prove</code> 后可以看到：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">error: post-condition does not hold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ┌─ ./sources/BasicCoin.move:58:9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">58 │         ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:45: transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:51: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:53: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:54: transfer (spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =     at ./sources/BasicCoin.move:45: transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         from = signer{0x0}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         to = 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         amount = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =         _witness = &lt;generic&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>令人有些出乎意料，Prover 提示了后置条件不满足，说明前面的 spec 块中的所描述的行为和 <code>transfer</code> 函数并不完全一致。
为什么会这样呢？我们再往下看：使得后置条件不满足的的参数是 <code>from = signer{0x0}</code> 和 <code>to = 0x0</code>.
看到这里我们应该清楚原因了：当账户向自己转账时，<code>to</code> 和 <code>from</code> 指向的地址都一样，所以余额不产生任何变化。</p><p>现在有两个解决方案：</p><p><strong>方案甲</strong> 不修改函数定义，改变规范，在 spec 块中分情况考虑转账收发账户二者是否是同一地址两种情形：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let post eq_post = balance_to == balance_to_post;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let post ne_post = balance_from_post == balance_from - amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; balance_to_post   == balance_to   + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from == to &amp;&amp; eq_post) || (addr_from != to &amp;&amp; ne_post);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者用另一种稍微直观些的 if 语法：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let post eq_post = balance_to == balance_to_post;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let post ne_post = balance_from_post == balance_from - amount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; balance_to_post   == balance_to   + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ensures if (addr_from == to) eq_post else ne_post;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意这里的 <code>if (P) E1 else E2</code> 和程序逻辑中的条件执行不太相同——
它实际上是个语法糖，等价于同时 <code>ensures</code> 了 <code>P ==&gt; E1</code> 和 <code>!P ==&gt; E2</code>。
而 <code>p ==&gt; q</code> 又实际上就是 <code>!p || q</code>.</p><p>也就是说，第二种写法的末尾实际上表示这样的逻辑：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from == to  ===&gt;  eq_post) &amp;&amp; (addr_from != to  ===&gt; ne_post);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>即：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ensures (addr_from != to || eq_post) &amp;&amp; (addr_from == to  || ne_post);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有兴趣的读者可以通过直值表或化简到范式的方式自行验证一下，
前面的 <code>(addr_from == to &amp;&amp; eq_post) || (addr_from != to &amp;&amp; ne_post)</code> 和后面的 <code>(addr_from != to || eq_post) &amp;&amp; (addr_from == to  || ne_post)</code> 实际上也是完全等价的表达式。</p><p><strong>方案乙</strong> 不修改 spec，直接在函数体内加上 <code>assert!(from_addr != to, EEQUAL_ADDR)</code>，
并在前面加上错误码 <code>EEQUAL_ADDR</code> 的定义，让自我转账交易无法完成。</p><p>显然，自己给自己转账并没有实际意义，不如直接禁止这种交易。
因此方案乙是更好的做法。它直接保证了成功执行时两者肯定不是同一地址，而且代码也更为简洁。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="练习">练习<a class="hash-link" href="#练习" title="标题的直接链接">​</a></h3><p>目前我们只完成了 <code>transfer</code> 函数的功能性验证。但没有说明它会在哪些情况下异常中止。
作为练习，请给它加上合适的 <code>aborts_if</code> 条件。答案可以在后面章节中找到。TODO</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证-mint-函数">验证 <code>mint</code> 函数<a class="hash-link" href="#验证-mint-函数" title="标题的直接链接">​</a></h2><p>函数 <code>mint</code> 的签名如下：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public fun mint&lt;CoinType: drop&gt;(mint_addr: address, amount: u64, _witness: CoinType) acquires Balance</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它负责铸造出金额为 <code>amount</code> 的代币，并存到地址 <code>mint_addr</code> 中。
比较有趣的是 <code>_witness</code>，其类型为 <code>CoinType</code>。
因为只有定义 <code>CoinType</code> 的模块才能构造出这个类型的值，这就保证了调用者身份。</p><p><code>mint</code> 函数中实际上只有一句对 <code>deposit</code> 的调用。不难想到，它们俩的要满足的规范应该有很多的相似之处。 照猫画虎，不难写出:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec mint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(mint_addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(mint_addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(mint_addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="验证-publish_balance-函数">验证 <code>publish_balance</code> 函数<a class="hash-link" href="#验证-publish_balance-函数" title="标题的直接链接">​</a></h2><p>函数 <code>publish_balance</code> 的签名如下：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public fun publish_balance&lt;CoinType&gt;(account: &amp;signer)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它在 <code>account</code> 下发布一个空的 <code>Balance&lt;CoinType&gt;</code> 类型的资源。因此如果资源已经存在时应当异常退出，而正常结束是余额应当是零：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec publish_balance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr = Signer::address_of(account);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用-schema-简化冗余规范">使用 Schema 简化冗余规范<a class="hash-link" href="#使用-schema-简化冗余规范" title="标题的直接链接">​</a></h2><p>恭喜！到目前为止，我们已经一步一步完成了 BasicCoin 的全部函数的验证。
但是，如果仔细看代码的话，不少 spec 块看起来十分相似，如果能让它们精简一些的话，文件结构会更清晰。</p><p>Schema 是一种通过将属性分组来构建规范的手段。
从语义上讲，它们也是语法糖，在 spec 块中使用它们等价于将它们包含的条件展开到函数、结构或模块。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="消除简单重复">消除简单重复<a class="hash-link" href="#消除简单重复" title="标题的直接链接">​</a></h3><p>作为一个最明显的例子，<code>mint</code> 和 <code>deposit</code> 的 spec 块除了变量名有点不一样（用术语来说，它们是<a href="https://en.wikipedia.org/wiki/Lambda_calculus#%CE%B1-conversion" target="_blank" rel="noopener noreferrer">可 alpha 转换</a>的），整体结构可以说是完全一致。
为了简化它们，我们来创建一个 Schema:</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec schema DepositSchema&lt;CoinType&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr: address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount: u64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个 Schema 声明了两个有类型的变量，以及一些关于这些变量应该满足的条件。
当其它地方想用这个 Schema 的时候，就要用 <code>include DepositSchema {addr: XX, amount: YY}</code> 来导入它。
其中 <code>XX</code> 和 <code>YY</code> 分是用来替代 <code>addr</code> 和 <code>amount</code> 的表达式。
如果表达式和对应的变量名正好一样，刚可以只写变量名，或者直接省略。</p><p>有了上面的 Schema 定义之后，我们现在可以简化之前的 spec 了：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec mint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  include DepositSchema&lt;CoinType&gt; {addr: mint_addr};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec deposit {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include DepositSchema&lt;CoinType&gt; {amount: check.value};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="schema-组合">Schema 组合<a class="hash-link" href="#schema-组合" title="标题的直接链接">​</a></h3><p>Schema 不仅可以消除上面这种几乎一样的重复，也可以组合起来，组成更为复杂的规范。</p><p>如果你按教程每一步进行了实验并完成了练习，现在你的 <code>tranfer</code> 函数的 spec 应该大概是这个样子：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 初始版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_from = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance_to = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_from_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr_from).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_to_post = global&lt;Balance&lt;CoinType&gt;&gt;(to).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr_from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(to);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance_from &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance_to + amount &gt; MAX_U64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if addr_from == to;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_from_post == balance_from - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_to_post == balance_to + amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>它虽然相对复杂，但经过一点分析还是不难看出，实际上糅合了 <code>withdraw</code> 和 <code>deposit</code> 两种逻辑。
这一点从 <code>transfer</code> 的调用关系也可以分析出来。</p><p>在前面一步当中，我们已经有了 <code>DepositSchema</code>。
现在，我们把 <code>withdraw</code> 的验证规范重构一下：把它提取成一个 Schema，以及一个用到此 Schema 的 spec 块：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec withdraw {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include WithdrawSchema&lt;CoinType&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures result == Coin&lt;CoinType&gt; { value: amount };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec schema WithdrawSchema&lt;CoinType&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr: address;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    amount: u64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let balance = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if !exists&lt;Balance&lt;CoinType&gt;&gt;(addr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if balance &lt; amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let post balance_post = global&lt;Balance&lt;CoinType&gt;&gt;(addr).coin.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensures balance_post == balance - amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有了这两个 Schema，我们可以方便地改写 <code>transfer</code> 的验证规范了：</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 使用 Schema 重构后</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec transfer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let addr_from = Signer::address_of(from);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include WithdrawSchema&lt;CoinType&gt; { addr: addr_from };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include DepositSchema&lt;CoinType&gt; { addr: to };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aborts_if addr_from == to;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>怎么样？和初始版本对比起来，现在是不是简单清晰多了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="练习-1">练习<a class="hash-link" href="#练习-1" title="标题的直接链接">​</a></h3><p>除了上面的示例以外，再找一个 spec 块（例如 <code>publish_balance</code>），将它也拆分成一个 Schema 声明和一个使用对应 Schema 的 spec 块。
作为一个练习，你创建的 Schema 可能在这份代码中无法利用，所以感觉看不出什么好处。
但如果在后面开发中，有别的函数调用 <code>publish_balance</code>，就会更方便了。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/starcoinorg/starcoin-cookbook/edit/main/i18n/zh/docusaurus-plugin-content-docs/current/03-move/100-move-prover/02-mvp-tutorial.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/docs/move/move-prover/move-spec-language"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Move 规范语言</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/docs/web3/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Dapp 开发指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-move-prover" class="table-of-contents__link toc-highlight">什么是 Move Prover</a></li><li><a href="#安装-prover-的依赖" class="table-of-contents__link toc-highlight">安装 Prover 的依赖</a></li><li><a href="#准备要验证的示例" class="table-of-contents__link toc-highlight">准备要验证的示例</a><ul><li><a href="#项目创建" class="table-of-contents__link toc-highlight">项目创建</a></li><li><a href="#模块代码" class="table-of-contents__link toc-highlight">模块代码</a></li><li><a href="#toml-配置" class="table-of-contents__link toc-highlight">TOML 配置</a></li></ul></li><li><a href="#第一段验证代码" class="table-of-contents__link toc-highlight">第一段验证代码</a></li><li><a href="#验证-withdraw-函数" class="table-of-contents__link toc-highlight">验证 <code>withdraw</code> 函数</a><ul><li><a href="#指定-widthdraw-的中止条件" class="table-of-contents__link toc-highlight">指定 <code>widthdraw</code> 的中止条件</a></li><li><a href="#指定-withdraw-的功能性质" class="table-of-contents__link toc-highlight">指定 <code>withdraw</code> 的功能性质</a></li></ul></li><li><a href="#验证-deposit-函数" class="table-of-contents__link toc-highlight">验证 <code>deposit</code> 函数</a></li><li><a href="#验证-transfer-函数" class="table-of-contents__link toc-highlight">验证 <code>transfer</code> 函数</a><ul><li><a href="#练习" class="table-of-contents__link toc-highlight">练习</a></li></ul></li><li><a href="#验证-mint-函数" class="table-of-contents__link toc-highlight">验证 <code>mint</code> 函数</a></li><li><a href="#验证-publish_balance-函数" class="table-of-contents__link toc-highlight">验证 <code>publish_balance</code> 函数</a></li><li><a href="#使用-schema-简化冗余规范" class="table-of-contents__link toc-highlight">使用 Schema 简化冗余规范</a><ul><li><a href="#消除简单重复" class="table-of-contents__link toc-highlight">消除简单重复</a></li><li><a href="#schema-组合" class="table-of-contents__link toc-highlight">Schema 组合</a></li><li><a href="#练习-1" class="table-of-contents__link toc-highlight">练习</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discor.gg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/starcoin_contributor" target="_blank" rel="noopener noreferrer" class="footer__link-item">Developer Telegram group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/StarcoinSTC" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/starcoinorg/starcoin" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Starcoin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.dce544f6.js"></script>
<script src="/zh/assets/js/main.4328e06e.js"></script>
</body>
</html>